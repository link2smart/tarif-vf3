<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogue DBX V2 (Secured)</title>
    <!-- React & UI -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF Engine (Pour lecture Fiches) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Excel Engine (Pour ONSSA) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .animate-fade { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Animation Bandeau Défilant */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: marquee 30s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        
        /* Canvas PDF Responsive */
        .pdf-canvas-container { overflow: auto; display: flex; justify-content: center; background-color: #525659; height: 100%; }
        canvas { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); margin: 20px 0; }
        
        /* Scrollbar moderne */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        /* Masquer la scrollbar horizontale sur la nav mobile tout en gardant le scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Component } = React;
        const { jsPDF } = window.jspdf;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-red-50 p-8 text-center">
                            <div className="max-w-lg">
                                <h1 className="text-2xl font-bold text-red-600 mb-4">Erreur Système</h1>
                                <p className="text-red-800 mb-6 bg-red-100 p-4 rounded text-left font-mono text-sm overflow-auto">{this.state.error?.toString()}</p>
                                <button onClick={() => window.location.reload()} className="bg-red-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-700">Relancer l'application</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Configuration PDF.js
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // --- SECURITE (OBFUSCATION) ---
        const _d = (s) => { 
            if(!s) return "";
            if(s.startsWith("AIza")) return s; 
            try { return atob(s); } catch(e) { return s; } 
        };

        // --- CONFIGURATION PERMANENTE (ADMIN) ---
        const HARDCODED_APP_KEY = "MGp4ZTNoNWhqOXZtMmxr"; 
        const HARDCODED_APP_SECRET = "dzM5c3VubWMxMGlhY3Ju"; 
        const HARDCODED_REFRESH_TOKEN = "PUVoOl2MP1IAAAAAAAAAAfD4l851BKyu6huy_CAttB9v_NCEAJo17TFmWim_YP7Q"; 
        const HARDCODED_GEMINI_KEY = "";   
        const HARDCODED_DBX_TOKEN = "sl.u.AGN2mejF9zW-5NxVUc0Dj2J-OOvQTGfALzT8nmGyhphGQpfy5RXRWeDFENtC44ThCRooxROaUzIxLUnblDYZm__P9Pru4DbwrPO1teKgGY-Q3R0UzPKit2feeeUFboEN50xzqiKzex9u20aLb5oyOaVvMLX007bdB7hOYcKQnMCFk4PB1pXufYtsl_x5-UxITVEa9kRrfXDQhmQBNBmp7adC96_J6CM-7i9-Jp8jlfhRi2WGM_OdsBXjtOUj_4QZKQ-CTgFTTvVdIzkSq0cqQhSjow7VUf41j6WJthfi3E8Y1eWb0DaJlDK7-Ivx8MedYdHGk0dM_Ug15nIJkOb4H7DvW_thLe-gTefvccGiuNXG18TI_ndofQj0GkhtZ8PmHNUNr8XpB71PLmyKutIHd2aeZQqXpmSf4EySkRm2ujMiSjIusVN5FSqj4DzgdR7no9v8i4gR9NrhCMlDyZ_oLDyHo-UE5iX_U-S3CcTN5EZgshrrT9Wg86fsDt1QChmw_PwfSaWfJlbY2PTqwyk9w1-HM0KKH1QO5L5NtcSJrD4cjg7hHbkbkt-UpawIoLfhPS8gI6QlYemCpaXn38ItPdJCIUxR_x5dQlIMAoQz-ubhK4A1YYM4UcvFGoaGoVoIbLD_AyFuqWcE-xU_hxpuJVl31j6I83J7_RARdiB1kupqNVtTUWk8khYefSNyYG40wX8RGonfFYPnpj0M_SBv3JfW3jf-IGMv-f2q9vV79FkqHVdImm0n5tgRecYQEHv5A6dA-S6HWU1wF57wBtuaVbHytepqbtlSZvOgJxgJ-rRT-3mIs67WA6I-MiqH--D4-jFv6ILfztvx0C9QBRniw4c9F5FSpojHQ-3C8P6c_YQaQsnjQ3wDHhTPGyOqMn5Di4-2Zhmh52VVnlapYyVyzQ-GhsyIh57R80c_VplkYhfO93aBav3FMF5j6eLCEOLI8dE0PK2eD1bCxq55kbyaYi5tlMXO4aYRsSTCMEolbCKwUKOBqobKPGiLP4gjwppBoFyU8xEKP14vFJc2VH3CgD1jJ0lTQ9tnIAWmsIQQXxFyotlJIdyebmEE5Sv61dhgQUEn2knotf_naw-l3mHNoIEiL4X8HCljVG7MP-EAIOYy2eVSl2IbsgPw_LO8SAo47sfajecs7OLuCVAyZakUhnLVTFrGRNFTkidfx6EGpgEjlVb428d0qwqVarmS8DvytrN5ZWtys_i6DulrED6orLFPQhIw52d8RmuwW_TnjPQP09ZZFyNcg_hGhQZzl_kIpSOWwJYLvTn2bJx2jMxDToLS"; 
        
        const DEFAULT_USERS = [
            { id: 'SUPERADMIN', pass: 'SUPER', role: 'admin', name: 'Super Admin', searchCount: 0 },
            { id: 'admin', pass: 'admin', role: 'admin', name: 'Administrateur', searchCount: 0 },
            { id: 'collab', pass: '1234', role: 'viewer', name: 'Collaborateur', searchCount: 0 }
        ];

        const delay = ms => new Promise(res => setTimeout(res, ms));

        // --- OAUTH HELPERS ---
        const exchangeCodeForToken = async (code, appKey, appSecret) => {
            const details = { 'code': code, 'grant_type': 'authorization_code', 'client_id': appKey, 'client_secret': appSecret };
            const formBody = Object.keys(details).map(key => encodeURIComponent(key) + '=' + encodeURIComponent(details[key])).join('&');
            const res = await fetch('https://api.dropbox.com/oauth2/token', {
                method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formBody
            });
            if(!res.ok) throw new Error(await res.text());
            return await res.json();
        };

        const refreshAccessToken = async (refreshToken, appKey, appSecret) => {
            try {
                const details = { 'grant_type': 'refresh_token', 'refresh_token': refreshToken, 'client_id': appKey, 'client_secret': appSecret };
                const formBody = Object.keys(details).map(key => encodeURIComponent(key) + '=' + encodeURIComponent(details[key])).join('&');
                const res = await fetch('https://api.dropbox.com/oauth2/token', {
                    method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formBody
                });
                const data = await res.json();
                if(data.access_token) return data.access_token;
                throw new Error("Pas de token dans la réponse refresh");
            } catch(e) {
                console.error("Echec Refresh:", e);
                return null;
            }
        };

        // --- API MANAGER ---
        const apiFetch = async (url, options, config, setConfig) => {
            const doRequest = async (token, retries = 3) => {
                const headers = { ...options.headers };
                if (token) headers['Authorization'] = `Bearer ${token}`;

                try {
                    const res = await fetch(url, { ...options, headers });
                    if (res.status === 401 && config.refreshToken && config.appKey && config.appSecret) {
                        console.warn("Token expiré (401). Tentative de rafraîchissement...");
                        const newToken = await refreshAccessToken(config.refreshToken, config.appKey, config.appSecret);
                        if (newToken) {
                            const newConfig = { ...config, token: newToken };
                            setConfig(newConfig);
                            localStorage.setItem('tdbx_config', JSON.stringify(newConfig));
                            return await doRequest(newToken, retries);
                        }
                    }
                    if (!res.ok && (res.status === 429 || res.status >= 500)) {
                        if (retries > 0) {
                            await delay(1500);
                            return await doRequest(token, retries - 1);
                        }
                    }
                    if (!res.ok) {
                        const errorText = await res.text();
                        if (errorText.includes("expired_access_token") || errorText.includes("invalid_access_token")) {
                            throw new Error("EXPIRED_TOKEN_ALERT");
                        }
                        throw new Error(errorText);
                    }
                    return res;
                } catch (err) {
                    if (retries > 0 && err.message !== "EXPIRED_TOKEN_ALERT") { await delay(1000); return await doRequest(token, retries - 1); }
                    throw err;
                }
            };
            
            let currentToken = config.token;
            if (!currentToken && config.refreshToken && config.appKey && config.appSecret) {
                 try {
                     const refreshed = await refreshAccessToken(config.refreshToken, config.appKey, config.appSecret);
                     if(refreshed) {
                         currentToken = refreshed;
                         setConfig({...config, token: refreshed});
                     }
                 } catch(e) { console.warn("Echec init refresh", e); }
            }
            return doRequest(currentToken);
        };

        // --- WRAPPERS SERVICES DROPBOX ---
        const DROPBOX_API_URL = "https://api.dropboxapi.com/2";
        const DROPBOX_CONTENT_URL = "https://content.dropboxapi.com/2";

        const dbxListFolder = async (config, setConfig) => {
            const res = await apiFetch(`${DROPBOX_API_URL}/files/list_folder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: config.pathTarifs === '/' ? '' : config.pathTarifs, recursive: false })
            }, config, setConfig);
            return await res.json();
        };

        const dbxListFolderFiches = async (config, setConfig) => {
            const res = await apiFetch(`${DROPBOX_API_URL}/files/list_folder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: config.pathFT === '/' ? '' : config.pathFT, recursive: false })
            }, config, setConfig);
            return await res.json();
        };

        const dbxDownloadFile = async (config, setConfig, path) => {
            const res = await apiFetch(`${DROPBOX_CONTENT_URL}/files/download`, {
                method: 'POST',
                headers: { 'Dropbox-API-Arg': JSON.stringify({ path }) }
            }, config, setConfig);
            return await res.blob();
        };

        const dbxUploadFile = async (config, setConfig, path, content) => {
            const res = await apiFetch(`${DROPBOX_CONTENT_URL}/files/upload`, {
                method: 'POST',
                headers: { 
                    'Dropbox-API-Arg': JSON.stringify({ path, mode: 'overwrite', mute: true }),
                    'Content-Type': 'application/octet-stream'
                },
                body: content
            }, config, setConfig);
            return await res.json();
        };

        // --- IA GOOGLE & HELPERS ---
        const callIA = async (payload, key, retryCount = 0) => {
            const modelVersion = 'gemini-2.5-flash-preview-09-2025';
            if (!key) throw new Error("Clé API Gemini manquante");

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelVersion}:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                
                if (res.status === 429) {
                    if (retryCount < 3) {
                        const waitTime = 2000 * Math.pow(2, retryCount);
                        await delay(waitTime);
                        return callIA(payload, key, retryCount + 1);
                    }
                    throw new Error("Quota IA épuisé (429).");
                }
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error?.message || `Erreur IA HTTP ${res.status}`);
                }
                return await res.json();
            } catch (e) { throw e; }
        };

        const extractJSON = (text) => {
            const firstBrace = text.indexOf('{');
            const lastBrace = text.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1) return text.substring(firstBrace, lastBrace + 1);
            return text;
        };

        const extractDateFromFilename = (filename) => {
            const regex = /(\d{1,2})[-._/](\d{1,2})[-._/](\d{2,4})/;
            const match = filename.match(regex);
            if (match) {
                let day = match[1].padStart(2, '0');
                let month = match[2].padStart(2, '0');
                let year = match[3];
                if (year.length === 2) year = '20' + year;
                return `${day}/${month}/${year}`;
            }
            return null;
        };

        const Icon = ({ name, size = 18, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current && name) {
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconRef.current.innerHTML = `<i data-lucide="${kebabName}"></i>`;
                    window.lucide.createIcons({ root: iconRef.current, attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        // --- UTILS PARSING PRIX EUROPEENS ---
        const parsePrice = (priceInput) => {
            if (priceInput === null || priceInput === undefined) return 0;
            let str = String(priceInput).trim();
            if (/^\d+(\.\d+)?$/.test(str)) return parseFloat(str);
            str = str.replace(/\s/g, '');
            str = str.replace(/\./g, '');
            str = str.replace(',', '.');
            str = str.replace(/[^0-9.]/g, '');
            const val = parseFloat(str);
            return isNaN(val) ? 0 : val;
        };

        // --- UTILS COMPARISON (EXISTANT) ---
        const getSimilarity = (s1, s2) => {
            let longer = s1; let shorter = s2;
            if (s1.length < s2.length) { longer = s2; shorter = s1; }
            const longerLength = longer.length;
            if (longerLength === 0) return 1.0;
            const editDistance = (str1, str2) => {
                str1 = str1.toLowerCase(); str2 = str2.toLowerCase();
                const costs = new Array();
                for (let i = 0; i <= str1.length; i++) {
                    let lastValue = i;
                    for (let j = 0; j <= str2.length; j++) {
                        if (i == 0) costs[j] = j;
                        else {
                            if (j > 0) {
                                let newValue = costs[j - 1];
                                if (str1.charAt(i - 1) != str2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                                costs[j - 1] = lastValue;
                                lastValue = newValue;
                            }
                        }
                    }
                    if (i > 0) costs[str2.length] = lastValue;
                }
                return costs[str2.length];
            };
            return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
        };

        const generateFluctuationReport = (oldProducts, newProducts) => {
            const report = { date: new Date().toLocaleString(), added: [], removed: [], changed: [] };
            const normalizeStr = (str) => {
                if (!str) return "";
                return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/[^a-z0-9\s]/g, '').split(/\s+/).sort().join(''); 
            };
            const getKey = (p) => { const n = normalizeStr(p.name); const pack = normalizeStr(p.packaging); return `${n}_${pack}`; };
            const oldMap = new Map();
            (oldProducts || []).forEach(p => { if(p.name) { const k = getKey(p); oldMap.set(k, p); p._used = false; } });
            (newProducts || []).forEach(newP => {
                if(!newP.name) return;
                const key = getKey(newP);
                let oldP = oldMap.get(key);
                if (!oldP) {
                    let bestMatch = null; let bestScore = 0;
                    for (let op of (oldProducts || [])) {
                        if (op._used) continue; 
                        const scoreName = getSimilarity(normalizeStr(newP.name), normalizeStr(op.name));
                        if (scoreName > 0.85) {
                            const scorePack = getSimilarity(normalizeStr(newP.packaging), normalizeStr(op.packaging));
                            if (scorePack > 0.80 || (!newP.packaging && !op.packaging)) {
                                if (scoreName > bestScore) { bestScore = scoreName; bestMatch = op; }
                            }
                        }
                    }
                    if (bestMatch) { oldP = bestMatch; oldMap.set(key, oldP); oldP._used = true; }
                } else { oldP._used = true; }
                if (!oldP) { report.added.push(newP); } else {
                    const priceOld = parsePrice(oldP.price); const priceNew = parsePrice(newP.price);
                    if (Math.abs(priceOld - priceNew) > 0.01) { 
                        report.changed.push({ name: newP.name, packaging: newP.packaging, oldPrice: priceOld.toFixed(2), newPrice: priceNew.toFixed(2), diff: (priceNew - priceOld).toFixed(2), unit: newP.unit || 'DH' });
                    }
                }
            });
            (oldProducts || []).forEach(oldP => { if(oldP.name && !oldP._used) { report.removed.push(oldP); } });
            return report;
        };

        // --- ONSSA UTILS (NEW & IMPROVED) ---
        const cleanOnssaName = (str) => {
            if (!str) return "";
            return str
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") 
                .toUpperCase()
                .replace(/\b(STE|SOCIETE|ETS|ETABLISSEMENT|GROUPE|SARL|AU|DE|LA|LE|LES|ET|AND|CO)\b/g, "") 
                .replace(/[^A-Z0-9]/g, "") 
                .trim();
        };

        const copyToClipboard = (text) => {
             const textArea = document.createElement("textarea"); textArea.value = text;
             textArea.style.position = "fixed"; document.body.appendChild(textArea);
             textArea.focus(); textArea.select();
             try { document.execCommand('copy'); return true; } catch (err) { return false; } finally { document.body.removeChild(textArea); }
        };

        // --- APPLICATION ---
        function App() {
            // STATE
            const [users, setUsers] = useState(DEFAULT_USERS);
            const [currentUser, setCurrentUser] = useState(null);
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [loginError, setLoginError] = useState('');

            const [tarifs, setTarifs] = useState([]);
            const [fiches, setFiches] = useState([]); 
            const [dbHistory, setDbHistory] = useState([]);
            const [dbMeta, setDbMeta] = useState(null);
            
            // SECURITY STATES
            const [pendingRequests, setPendingRequests] = useState([]);
            const [authorizedDevices, setAuthorizedDevices] = useState([]);
            const [deviceId, setDeviceId] = useState('');
            const [manualAddId, setManualAddId] = useState(''); 
            const [manualAddName, setManualAddName] = useState('');

            // QUOTE STATE
            const [quote, setQuote] = useState({ client: '', items: [] });
            const [showQuoteProductModal, setShowQuoteProductModal] = useState(false);
            const [quoteSearchQuery, setQuoteSearchQuery] = useState('');
            const [selectedProductForQuote, setSelectedProductForQuote] = useState(null);
            const [quoteItemForm, setQuoteItemForm] = useState({ price: 0, qty: 1, discountVal: 0, discountType: 'percent' });
            
            // SAVED QUOTES
            const [savedQuotes, setSavedQuotes] = useState([]);
            const [showSavedQuotesModal, setShowSavedQuotesModal] = useState(false);

            // ONSSA STATE (NEW)
            const [onssaData, setOnssaData] = useState({ baseList: [], newList: [], report: null, baseDate: '', newDate: '' });
            const [isOnssaAnalyzing, setIsOnssaAnalyzing] = useState(false);
            const [onssaProgress, setOnssaProgress] = useState('');
            const [availableRegions, setAvailableRegions] = useState([]);
            const [selectedRegions, setSelectedRegions] = useState([]);

            const [dbxConfig, setDbxConfig] = useState({ 
                token: HARDCODED_DBX_TOKEN, 
                refreshToken: HARDCODED_REFRESH_TOKEN || '', 
                appKey: _d(HARDCODED_APP_KEY) || '', 
                appSecret: _d(HARDCODED_APP_SECRET) || '', 
                pathTarifs: '/Tarifs', 
                pathFT: '/Fiches', 
                geminiKey: _d(HARDCODED_GEMINI_KEY) || '' 
            });
            
            const [view, setView] = useState('login'); 
            const [activeTab, setActiveTab] = useState('search'); 
            const [searchQuery, setSearchQuery] = useState('');
            const [syncLog, setSyncLog] = useState('');
            const [syncStatus, setSyncStatus] = useState('idle');
            const [isUploading, setIsUploading] = useState(false);
            const [showConfigModal, setShowConfigModal] = useState(false); 

            // UI Notifications & Confirmations
            const [toasts, setToasts] = useState([]);
            const [confirmModal, setConfirmModal] = useState({ show: false, title: '', message: '', onConfirm: null });

            const showToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => { setToasts(prev => prev.filter(t => t.id !== id)); }, 4000);
            };

            const askConfirm = (title, message, onConfirm) => { setConfirmModal({ show: true, title, message, onConfirm }); };
            const handleConfirmYes = async () => { if (confirmModal.onConfirm) await confirmModal.onConfirm(); setConfirmModal({ ...confirmModal, show: false }); };

            // CALCULATRICE STATE
            const [calcState, setCalcState] = useState({ show: false, product: null, basePrice: 0, baseLabel: '' });
            const [extraDiscount, setExtraDiscount] = useState('');

            // REPORT VIEWER STATE
            const [viewingReport, setViewingReport] = useState(null);

            // VISUALISATEUR STATE
            const [viewingFile, setViewingFile] = useState(null);
            const [isFileLoading, setIsFileLoading] = useState(false);
            const [pdfState, setPdfState] = useState({ pdfDoc: null, pageNum: 1, numPages: 0, scale: 1.0 });
            const canvasRef = useRef(null);

            // ADMIN UI
            const [showAdminUploadModal, setShowAdminUploadModal] = useState(false);
            const [adminUploadMode, setAdminUploadMode] = useState('new');
            const [targetTarifId, setTargetTarifId] = useState('');
            const [authCode, setAuthCode] = useState(''); 
            const [t4Value, setT4Value] = useState(0);
            
            // USER EDIT UI
            const [editingUserIdx, setEditingUserIdx] = useState(null);
            const [userFormData, setUserFormData] = useState({ name: '', login: '', pass: '', role: 'viewer' });
            const [showPassword, setShowPassword] = useState({});

            const uploadInputRef = useRef(null);
            const adminFileInputRef = useRef(null);
            const onssaBaseInputRef = useRef(null);
            const onssaNewInputRef = useRef(null);

            useEffect(() => {
                let did = localStorage.getItem('tdbx_deviceId');
                if (!did) {
                    did = 'dev_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                    localStorage.setItem('tdbx_deviceId', did);
                }
                setDeviceId(did);
            }, []);

            useEffect(() => {
                const storedConfig = localStorage.getItem('tdbx_config');
                const storedUsers = localStorage.getItem('tdbx_users');
                const storedTarifs = localStorage.getItem('tdbx_tarifs'); 
                const storedFiches = localStorage.getItem('tdbx_fiches');
                const storedHistory = localStorage.getItem('tdbx_history');
                const storedMeta = localStorage.getItem('tdbx_meta');

                if (storedConfig) {
                    const parsed = JSON.parse(storedConfig);
                    if(HARDCODED_DBX_TOKEN && !parsed.token) parsed.token = HARDCODED_DBX_TOKEN;
                    const decodedRefresh = HARDCODED_REFRESH_TOKEN;
                    const decodedKey = _d(HARDCODED_APP_KEY);
                    const decodedSecret = _d(HARDCODED_APP_SECRET);
                    const decodedGemini = _d(HARDCODED_GEMINI_KEY);
                    if(decodedRefresh) parsed.refreshToken = decodedRefresh;
                    if(decodedKey) parsed.appKey = decodedKey;
                    if(decodedSecret) parsed.appSecret = decodedSecret;
                    if(decodedGemini) parsed.geminiKey = decodedGemini;
                    setDbxConfig(parsed);
                } else {
                    setDbxConfig(prev => ({
                        ...prev, 
                        token: HARDCODED_DBX_TOKEN,
                        refreshToken: HARDCODED_REFRESH_TOKEN,
                        appKey: _d(HARDCODED_APP_KEY),
                        appSecret: _d(HARDCODED_APP_SECRET),
                        geminiKey: _d(HARDCODED_GEMINI_KEY)
                    }));
                }

                if (storedUsers) setUsers(JSON.parse(storedUsers));
                if (storedTarifs) setTarifs(JSON.parse(storedTarifs));
                if (storedFiches) setFiches(JSON.parse(storedFiches));
                if (storedHistory) setDbHistory(JSON.parse(storedHistory));
                if (storedMeta) setDbMeta(JSON.parse(storedMeta));
            }, []);

            useEffect(() => { if(currentUser) localStorage.setItem('tdbx_config', JSON.stringify(dbxConfig)); }, [dbxConfig, currentUser]);
            useEffect(() => { if(currentUser) localStorage.setItem('tdbx_users', JSON.stringify(users)); }, [users, currentUser]);

            useEffect(() => {
                let interval;
                if ((currentUser || view === 'login') && (dbxConfig.token || (dbxConfig.refreshToken && dbxConfig.appKey))) {
                    if(tarifs.length === 0 || view === 'login') loadCloudDatabase(view !== 'login');
                    interval = setInterval(() => { loadCloudDatabase(true); }, 60000);
                }
                return () => clearInterval(interval);
            }, [currentUser, dbxConfig.token, dbxConfig.refreshToken, view]);

            // --- ONSSA EXCEL LOGIC START ---

            const handleOnssaExcel = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setIsOnssaAnalyzing(true);
                setOnssaProgress("Lecture Excel Manuellement Raffiné...");

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = evt.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        // Utilisation simple de sheet_to_json en mode header: 1 pour récupérer les lignes brutes
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        let rows = [];
                        let detectedDate = null;

                        // 1. DÉTECTION DATE (dans les 15 premières lignes)
                        for(let i=0; i<Math.min(jsonData.length, 15); i++) {
                            const rowText = (jsonData[i] || []).join(' ');
                            // Regex flexible pour "Arrêtée au..." ou "Arrêté le..."
                            // Capture tout jusqu'à la fin de la ligne ou une parenthèse
                            const dateMatch = rowText.match(/(?:arr[êeé]t[ée]e?)\s+(?:le|au)\s+([^.\n]+)/i);
                            if (dateMatch) {
                                detectedDate = "Arrêtée le " + dateMatch[1].trim();
                                break;
                            }
                        }
                        
                        // ON SUPPOSE QUE LE FICHIER A ÉTÉ NETTOYÉ MANUELLEMENT
                        // NOUVELLE STRUCTURE : Region | Ville | Nom | Adresse
                        // On ignore la première ligne (En-tête)
                        
                        for(let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if(row && row.length > 2) { 
                                // Mapping STRICT des colonnes
                                const region = row[0] || "";
                                const ville = row[1] || "";
                                const nom = row[2] || "";
                                const adresse = row[3] || "";

                                if(nom && (nom+"").trim().length > 1) {
                                    rows.push({
                                        region: (region + "").trim().toUpperCase(),
                                        ville: (ville + "").trim(),
                                        nom: (nom + "").trim(),
                                        adresse: (adresse + "").trim()
                                    });
                                }
                            }
                        }

                        const fileDate = detectedDate || `Excel importé le ${new Date().toLocaleDateString()}`;

                        if (type === 'base') {
                            const newData = { ...onssaData, baseList: rows, baseDate: fileDate };
                            setOnssaData(newData);
                            saveOnssaToCloud(newData);
                            showToast(`Base chargée : ${rows.length} entrées`, "success");
                        } else {
                            const newData = { ...onssaData, newList: rows, newDate: fileDate };
                            setOnssaData(newData);
                            compareOnssaLists(onssaData.baseList, rows, onssaData.baseDate, fileDate);
                        }

                    } catch (err) {
                        console.error(err);
                        showToast("Erreur analyse Excel : " + err.message, "error");
                    } finally {
                        setIsOnssaAnalyzing(false);
                        setOnssaProgress('');
                    }
                };
                reader.readAsBinaryString(file);
            };

            // LOGIQUE DE COMPARAISON INTELLIGENTE
            const compareOnssaLists = (base, latest, dBase, dNew) => {
                if (!base || base.length === 0) return showToast("Liste de base vide.", "warning");
                
                setOnssaProgress("Comparaison intelligente en cours...");
                
                let remainingBase = [...base];
                const added = [];
                const allRegions = new Set();

                latest.forEach(newItem => {
                    if(newItem.region && newItem.region !== "INCONNUE") allRegions.add(newItem.region.toUpperCase());

                    const newItemNameClean = cleanOnssaName(newItem.nom);
                    const newItemCityClean = cleanOnssaName(newItem.ville);

                    // Recherche match dans la base
                    const bestMatchIndex = remainingBase.findIndex(baseItem => {
                        const baseItemCityClean = cleanOnssaName(baseItem.ville);
                        // Filtre ville (match exact ou très proche)
                        if (getSimilarity(newItemCityClean, baseItemCityClean) < 0.8) return false;

                        const baseItemNameClean = cleanOnssaName(baseItem.nom);
                        // Match nom fuzzy
                        return getSimilarity(newItemNameClean, baseItemNameClean) > 0.85;
                    });

                    if (bestMatchIndex !== -1) {
                        // C'est le même -> on l'enlève de la liste des "disparus potentiels"
                        remainingBase.splice(bestMatchIndex, 1);
                    } else {
                        // Nouveau
                        added.push(newItem);
                    }
                });

                // Ce qui reste dans remainingBase sont les supprimés
                const removed = remainingBase;
                
                // Collect regions from removed as well
                removed.forEach(r => { if(r.region && r.region !== "INCONNUE") allRegions.add(r.region.toUpperCase()); });

                const regionsArray = Array.from(allRegions).sort();
                setAvailableRegions(regionsArray);
                // Par défaut, sélectionner TOUTES les régions
                setSelectedRegions(regionsArray);

                // Group by Region only (Province is removed)
                // structure: { "REGION X": [items...] }
                const groupByRegion = (arr) => {
                    return arr.reduce((acc, curr) => {
                        const reg = (curr.region || "AUTRE").toUpperCase();
                        
                        if (!acc[reg]) acc[reg] = [];
                        
                        acc[reg].push(curr);
                        return acc;
                    }, {});
                };

                const report = {
                    dateGenerated: new Date().toLocaleString(),
                    baseDate: dBase,
                    newDate: dNew,
                    added: groupByRegion(added),
                    removed: groupByRegion(removed),
                    countAdded: added.length,
                    countRemoved: removed.length,
                    rawAdded: added, // Keep flat lists for filtering later
                    rawRemoved: removed
                };

                const newData = { ...onssaData, newList: latest, newDate: dNew, report: report };
                setOnssaData(newData);
                saveOnssaToCloud(newData); // Save result
                showToast(`Comparaison terminée. Sélectionnez les régions pour le rapport.`, "success");
                setOnssaProgress('');
            };

            const toggleRegion = (reg) => {
                if(selectedRegions.includes(reg)) {
                    setSelectedRegions(selectedRegions.filter(r => r !== reg));
                } else {
                    setSelectedRegions([...selectedRegions, reg]);
                }
            };

            const toggleAllRegions = () => {
                if(selectedRegions.length === availableRegions.length) setSelectedRegions([]);
                else setSelectedRegions([...availableRegions]);
            };

            const saveOnssaToCloud = async (data) => {
                try {
                    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                    await dbxUploadFile(dbxConfig, setDbxConfig, '/onssa_db.json', blob);
                } catch(e) { console.error("Erreur save ONSSA", e); }
            };

            const loadOnssaFromCloud = async () => {
                try {
                    const blob = await dbxDownloadFile(dbxConfig, setDbxConfig, '/onssa_db.json');
                    const text = await blob.text();
                    const data = JSON.parse(text);
                    setOnssaData(data);
                    
                    // Restore regions if report exists
                    if(data.report) {
                        const allRegs = new Set();
                        if(data.report.rawAdded) data.report.rawAdded.forEach(r => r.region && r.region !== "INCONNUE" && allRegs.add(r.region.toUpperCase()));
                        if(data.report.rawRemoved) data.report.rawRemoved.forEach(r => r.region && r.region !== "INCONNUE" && allRegs.add(r.region.toUpperCase()));
                        if(data.newList) data.newList.forEach(r => r.region && r.region !== "INCONNUE" && allRegs.add(r.region.toUpperCase()));
                        
                        const regArr = Array.from(allRegs).sort();
                        setAvailableRegions(regArr);
                        setSelectedRegions(regArr); 
                    }
                    showToast("Données ONSSA chargées.", "success");
                } catch(e) { }
            };

            const generateOnssaReportPDF = () => {
                if (!onssaData.report) return;
                const r = onssaData.report;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(22); doc.setTextColor(37, 99, 235); doc.text("Rapport Comparatif ONSSA", 14, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(`Généré le: ${r.dateGenerated}`, 14, 26);
                
                // Filter content based on selected regions
                const regionsToPrint = selectedRegions.map(reg => reg.toUpperCase());
                doc.setFontSize(9); doc.setTextColor(80);
                const regionText = regionsToPrint.length === availableRegions.length ? "TOUTES RÉGIONS" : regionsToPrint.join(', ');
                const splitRegionText = doc.splitTextToSize(`Filtre : ${regionText}`, 180);
                doc.text(splitRegionText, 14, 32);
                
                let currentY = 36 + (splitRegionText.length * 4);
                doc.setDrawColor(200); doc.line(14, currentY, 196, currentY);
                currentY += 6;

                // Dates
                doc.setFontSize(11); doc.setTextColor(0);
                doc.text(`Comparaison : ${r.baseDate} vs ${r.newDate}`, 14, currentY);
                currentY += 10;

                // FONCTION D'AFFICHAGE TABLEAU
                const printTable = (title, color, dataMap) => {
                    // Filter map by selected regions
                    const filteredMap = {};
                    Object.keys(dataMap).forEach(reg => {
                        if(regionsToPrint.includes(reg)) {
                            filteredMap[reg] = dataMap[reg];
                        }
                    });

                    // Count total for this section after filter
                    let totalCount = 0;
                    Object.values(filteredMap).forEach(items => totalCount += items.length);

                    if(totalCount === 0) return;

                    if (currentY > 260) { doc.addPage(); currentY = 20; }
                    doc.setFontSize(14); doc.setTextColor(color[0], color[1], color[2]);
                    doc.text(`${title} (${totalCount})`, 14, currentY);
                    currentY += 6;

                    const tableRows = [];
                    
                    Object.keys(filteredMap).sort().forEach(reg => {
                        // Header Région
                        tableRows.push([{ content: `RÉGION : ${reg}`, colSpan: 3, styles: { fillColor: [240, 240, 240], textColor: [50,50,50], fontStyle: 'bold', halign: 'center' } }]);
                        
                        const items = filteredMap[reg];
                        // Sort by Ville
                        items.sort((a,b) => (a.ville || "").localeCompare(b.ville || ""));

                        items.forEach(item => {
                            tableRows.push([
                                item.ville || "",
                                item.nom || "",
                                item.adresse || ""
                            ]);
                        });
                    });

                    doc.autoTable({
                        startY: currentY,
                        head: [['Ville / Localité', 'Nom / Raison Sociale', 'Adresse']],
                        body: tableRows,
                        theme: 'grid',
                        headStyles: { fillColor: [100, 100, 100] },
                        styles: { fontSize: 8, cellPadding: 2 },
                        columnStyles: {
                            0: { cellWidth: 30, fontStyle: 'bold' },
                            1: { cellWidth: 70 },
                            2: { cellWidth: 'auto' }
                        },
                        margin: { top: 20 }
                    });
                    
                    currentY = doc.lastAutoTable.finalY + 15;
                };

                // 1. AJOUTÉS
                printTable("Revendeurs AJOUTÉS (Nouveaux Agréments)", [22, 163, 74], r.added); // Vert

                // 2. RETIRÉS
                printTable("Revendeurs RETIRÉS (Agréments Perdus)", [220, 38, 38], r.removed); // Rouge

                doc.save(`Rapport_ONSSA_${new Date().toISOString().slice(0,10)}.pdf`);
            };

            // --- ONSSA EXCEL LOGIC END ---

            const handleExchangeCode = async () => {
                if(!authCode || !dbxConfig.appKey || !dbxConfig.appSecret) return showToast("Infos manquantes (App Key, Secret, Code).", 'error');
                setSyncStatus('working');
                try {
                    const data = await exchangeCodeForToken(authCode, dbxConfig.appKey, dbxConfig.appSecret);
                    const newConfig = { ...dbxConfig, token: data.access_token, refreshToken: data.refresh_token };
                    setDbxConfig(newConfig);
                    localStorage.setItem('tdbx_config', JSON.stringify(newConfig));
                    await secureCloudUpdate(d => ({ ...d, config: newConfig }));
                    setSyncLog("✅ Refresh Token configuré et partagé !");
                    setSyncStatus('success');
                    setAuthCode('');
                    showToast("Succès !", 'success');
                } catch(e) {
                    setSyncLog("❌ Erreur OAuth : " + e.message);
                    setSyncStatus('error');
                    showToast("Erreur : " + e.message, 'error');
                }
            };

            // --- SECURE CLOUD UPDATE TRANSACTION ---
            // Cette fonction remplace l'ancien "saveToCloud" pour toutes les modifications
            const secureCloudUpdate = async (updateLogicFn) => {
                if (!currentUser || (currentUser.role !== 'admin' && currentUser.id !== 'SUPERADMIN')) {
                    showToast("Action refusée : Droits administrateur requis.", "error");
                    return;
                }

                setSyncStatus('working');
                try {
                    // 1. Fetch latest Data
                    let latestData = {};
                    try {
                        const blob = await dbxDownloadFile(dbxConfig, setDbxConfig, '/db_tarifs.json');
                        const text = await blob.text();
                        latestData = JSON.parse(text);
                    } catch(readErr) {
                        // Si le fichier n'existe pas, on initialise avec des valeurs par défaut
                        latestData = { tarifs: [], fiches: [], history: [], users: DEFAULT_USERS, pendingRequests: [], authorizedDevices: [], savedQuotes: [] };
                    }

                    // 2. Apply Update Logic (Transaction)
                    const newData = updateLogicFn(latestData);
                    
                    // 3. Update Meta
                    newData.meta = { date: new Date().toLocaleString(), user: currentUser?.name || 'System' };

                    // 4. Upload
                    await dbxUploadFile(dbxConfig, setDbxConfig, '/db_tarifs.json', new Blob([JSON.stringify(newData)], { type: 'application/json' }));

                    // 5. Update Local State to reflect changes
                    if(newData.tarifs) setTarifs(newData.tarifs);
                    if(newData.fiches) setFiches(newData.fiches);
                    if(newData.history) setDbHistory(newData.history);
                    if(newData.users) setUsers(newData.users);
                    if(newData.pendingRequests) setPendingRequests(newData.pendingRequests);
                    if(newData.authorizedDevices) setAuthorizedDevices(newData.authorizedDevices);
                    if(newData.savedQuotes) setSavedQuotes(newData.savedQuotes);

                    setSyncStatus('success');
                    showToast("Mise à jour sécurisée effectuée", "success");
                } catch (e) {
                    setSyncStatus('error');
                    console.error(e);
                    showToast("Erreur synchro sécurisée: " + e.message, "error");
                }
            };

            const loadCloudDatabase = async (silent = false) => {
                if (!dbxConfig.token && !(dbxConfig.refreshToken && dbxConfig.appKey)) return;
                if (!silent) { setSyncStatus('working'); setSyncLog("Chargement Cloud..."); }
                try {
                    const blob = await dbxDownloadFile(dbxConfig, setDbxConfig, '/db_tarifs.json');
                    const text = await blob.text();
                    const data = JSON.parse(text);
                    setTarifs(data.tarifs || []);
                    setFiches(data.fiches || []);
                    setDbHistory(data.history || []);
                    if (data.meta) setDbMeta(data.meta);
                    if (data.users && Array.isArray(data.users)) {
                        setUsers(data.users);
                        localStorage.setItem('tdbx_users', JSON.stringify(data.users));
                    }
                    if (data.pendingRequests) setPendingRequests(data.pendingRequests);
                    if (data.authorizedDevices) setAuthorizedDevices(data.authorizedDevices);
                    if (data.savedQuotes) setSavedQuotes(data.savedQuotes || []); // Load Saved Quotes

                    if (data.config && data.config.refreshToken) {
                        if (data.config.refreshToken && data.config.refreshToken !== dbxConfig.refreshToken) {
                            const newSharedConfig = { ...dbxConfig, ...data.config };
                            setDbxConfig(newSharedConfig);
                            localStorage.setItem('tdbx_config', JSON.stringify(newSharedConfig));
                            if (!silent) console.log("Config OAuth mise à jour.");
                        }
                    }
                    if (!silent) { setSyncLog("✅ Données à jour."); setSyncStatus('success'); }
                    
                    // Load ONSSA Data if logged in
                    if (!silent && currentUser?.role === 'admin') loadOnssaFromCloud();

                } catch (e) {
                    if (e.message === "EXPIRED_TOKEN_ALERT") {
                        if (!silent) { 
                            setSyncLog("⚠️ Token expiré.");
                            setSyncStatus('error');
                            if(users.length <= 2) setShowConfigModal(true);
                        }
                    } else {
                        if (!silent) { setSyncLog("⚠️ Erreur Sync : " + e.message); setSyncStatus('error'); }
                    }
                }
            };

            // ... (Calculator & Quote logic unchanged)
            const openCalculator = (product, prices) => {
                let base = 0;
                let label = '';
                if (product) { // Added check
                    if (prices.t4) { 
                        base = parseFloat(prices.t4); 
                        label = 'Prix T4'; 
                    } else if (prices.ttc) { 
                        base = parseFloat(prices.ttc); 
                        label = 'Prix TTC'; 
                    } else { 
                        base = parseFloat(prices.ht); 
                        label = 'Prix HT (Exo)'; 
                    }
                    setCalcState({ show: true, product, basePrice: base, baseLabel: label });
                    setExtraDiscount('');
                }
            };

            const openQuoteProductModal = () => {
                setShowQuoteProductModal(true);
                setQuoteSearchQuery('');
                setSelectedProductForQuote(null);
            };

            const selectProductForQuote = (product) => {
                if (!product) return; // Added check
                let basePrice = parsePrice(product.price);
                if (product.t4_percentage > 0) {
                    basePrice = basePrice * (1 - product.t4_percentage / 100);
                }
                setSelectedProductForQuote(product);
                setQuoteItemForm({ price: basePrice, qty: 1, discountVal: 0, discountType: 'percent' });
            };

            const addQuoteItem = () => {
                if (!selectedProductForQuote) return;
                const isTaxable = selectedProductForQuote.name && (selectedProductForQuote.name.trim().startsWith('*') || selectedProductForQuote.name.trim().endsWith('*'));
                const newItem = {
                    id: Date.now(),
                    name: selectedProductForQuote.name,
                    packaging: selectedProductForQuote.packaging,
                    unit: selectedProductForQuote.unit || 'DH',
                    basePrice: quoteItemForm.price,
                    qty: quoteItemForm.qty,
                    discountVal: quoteItemForm.discountVal,
                    discountType: quoteItemForm.discountType,
                    isTaxable: !!isTaxable
                };
                setQuote(prev => ({ ...prev, items: [...prev.items, newItem] }));
                setShowQuoteProductModal(false);
                setSelectedProductForQuote(null);
                showToast("Produit ajouté au devis", 'success');
            };

            const removeQuoteItem = (id) => {
                setQuote(prev => ({ ...prev, items: prev.items.filter(item => item.id !== id) }));
            };

            const calculateLineTotal = (item) => {
                if (!item) return 0; // Guard clause
                let finalPrice = item.basePrice || 0;
                if (item.discountType === 'percent') {
                    finalPrice = finalPrice * (1 - ((item.discountVal || 0) / 100));
                } else {
                    finalPrice = finalPrice - (item.discountVal || 0);
                }
                return finalPrice * (item.qty || 1);
            };

            // NEW: SAVE QUOTE LOGIC
            const handleSaveQuote = async () => {
                if (!quote.client) return showToast("Nom du client requis", 'warning');
                if (quote.items.length === 0) return showToast("Le devis est vide", 'warning');
                
                const newSavedQuote = {
                    id: Date.now(),
                    saveDate: new Date().toLocaleString(),
                    client: quote.client,
                    items: quote.items,
                    creator: currentUser?.name || 'Inconnu'
                };

                await secureCloudUpdate(currentData => {
                    const existingQuotes = currentData.savedQuotes || [];
                    return {
                        ...currentData,
                        savedQuotes: [newSavedQuote, ...existingQuotes]
                    };
                });
                
                showToast("Devis sauvegardé dans le Cloud !", 'success');
            };

            const handleLoadQuote = (savedQ) => {
                setQuote({ client: savedQ.client, items: savedQ.items });
                setShowSavedQuotesModal(false);
                showToast("Devis chargé !", 'success');
            };

            const handleDeleteSavedQuote = async (id) => {
                if(!confirm("Supprimer ce devis sauvegardé ?")) return;
                await secureCloudUpdate(currentData => {
                    const existingQuotes = currentData.savedQuotes || [];
                    return {
                        ...currentData,
                        savedQuotes: existingQuotes.filter(q => q.id !== id)
                    };
                });
                showToast("Devis supprimé !", 'success');
            };


            const generateQuotePDF = () => {
                if (!quote.client) return showToast("Veuillez saisir le nom du client", 'warning');
                if (quote.items.length === 0) return showToast("Ajoutez des articles au devis", 'warning');

                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                
                doc.setFontSize(22);
                doc.setTextColor(37, 99, 235); 
                doc.text("CMGP-CAS", 14, 20); 
                
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("Portail Unifié", 14, 26);

                doc.setFontSize(14);
                doc.setTextColor(0);
                doc.text("DEVIS", pageWidth - 14, 20, { align: 'right' });
                doc.setFontSize(10);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth - 14, 26, { align: 'right' });
                
                doc.setDrawColor(200);
                doc.line(14, 32, pageWidth - 14, 32);

                doc.setFontSize(11);
                doc.text(`Émis par: ${currentUser?.name || 'Utilisateur'}`, 14, 42);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`Client: ${quote.client}`, pageWidth - 14, 42, { align: 'right' });
                doc.setFont(undefined, 'normal');

                const tableRows = quote.items.filter(i => i).map(item => { // Filter nulls
                    let finalPriceUnit = item.basePrice || 0;
                    if (item.discountType === 'percent') {
                        finalPriceUnit = finalPriceUnit * (1 - ((item.discountVal || 0) / 100));
                    } else {
                        finalPriceUnit = finalPriceUnit - (item.discountVal || 0);
                    }
                    const tvaRate = item.isTaxable ? 0.20 : 0;
                    const finalPriceUnitTTC = finalPriceUnit * (1 + tvaRate);

                    return [
                        `${item.name}${item.packaging ? ` (${item.packaging})` : ''}`,
                        item.qty,
                        finalPriceUnit.toFixed(2), 
                        finalPriceUnitTTC.toFixed(2), 
                        (finalPriceUnit * item.qty).toFixed(2) 
                    ];
                });

                doc.autoTable({
                    startY: 50,
                    head: [['Désignation', 'Qté', 'P.U. Net HT', 'P.U. TTC', 'Total HT']], 
                    body: tableRows,
                    theme: 'striped',
                    headStyles: { fillColor: [37, 99, 235] },
                    styles: { fontSize: 9, cellPadding: 3 }, 
                    columnStyles: {
                        0: { cellWidth: 'auto' },
                        1: { cellWidth: 15, halign: 'center' },
                        2: { cellWidth: 25, halign: 'right' },
                        3: { cellWidth: 25, halign: 'right' }, 
                        4: { cellWidth: 30, halign: 'right', fontStyle: 'bold' }
                    }
                });

                let totalHT = 0;
                let totalTVA = 0;

                quote.items.forEach(item => {
                    if (!item) return; // Protection loop
                    const lineTotal = calculateLineTotal(item);
                    totalHT += lineTotal;
                    if(item.isTaxable) {
                        totalTVA += lineTotal * 0.20;
                    }
                });

                const totalTTC = totalHT + totalTVA;
                const finalY = doc.lastAutoTable.finalY + 10;
                if (finalY > doc.internal.pageSize.height - 50) doc.addPage();

                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 10,
                    body: [
                        ['Total HT', `${totalHT.toFixed(2)} DH`],
                        ['TVA (20%)', `${totalTVA.toFixed(2)} DH`],
                        ['Total TTC', `${totalTTC.toFixed(2)} DH`]
                    ],
                    theme: 'plain',
                    styles: { fontSize: 10, cellPadding: 2, halign: 'right' },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 'auto' },
                        1: { cellWidth: 40, fontStyle: 'normal' }
                    },
                    margin: { left: pageWidth - 100 }
                });
                doc.setFont(undefined, 'bold');
                doc.setTextColor(37, 99, 235);
                doc.save(`Devis_${quote.client}_${Date.now()}.pdf`);
                showToast("Devis téléchargé !", 'success');
            };

            const flattenedProducts = useMemo(() => {
                const all = [];
                (tarifs || []).forEach(t => {
                    if (t && t.products && Array.isArray(t.products)) {
                        t.products.forEach(p => {
                            if (p) { // Add check
                                all.push({
                                    ...p,
                                    source: t.name,
                                    t4_percentage: t.t4_percentage || 0
                                });
                            }
                        });
                    }
                });
                return all;
            }, [tarifs]);

            const quoteSearchResults = useMemo(() => {
                if (!quoteSearchQuery || quoteSearchQuery.length < 2) return [];
                const q = quoteSearchQuery.toLowerCase();
                return (flattenedProducts || []).filter(p => p.name?.toLowerCase().includes(q)).slice(0, 50);
            }, [quoteSearchQuery, flattenedProducts]);


            // --- LOGIN & ACTIONS ---
            const handleLogin = async (e) => {
                e.preventDefault();
                setSyncStatus('working');
                await loadCloudDatabase(true);
                setSyncStatus('idle');

                const user = users.find(u => u.id === loginForm.username && u.pass === loginForm.password);
                if (user) {
                    if (user.role === 'admin' || user.id === 'SUPERADMIN') {
                        setCurrentUser(user);
                        setLoginError('');
                        setView('dashboard');
                        
                        // NEW ADMIN LOGIN FLOW: NO AUTO-WRITE
                        // We check authorization locally for UI feedback, but do NOT update DB.
                        if (!dbxConfig.token && !dbxConfig.refreshToken && !HARDCODED_DBX_TOKEN) setShowConfigModal(true);
                        // LOAD ONSSA DATA ON ADMIN LOGIN
                        loadOnssaFromCloud();
                        return;
                    }

                    // VIEWER SECURITY CHECK (READ ONLY)
                    const isAuth = authorizedDevices.some(d => (typeof d === 'string' ? d : d.id) === deviceId);
                    if (isAuth) {
                        setCurrentUser(user);
                        setLoginError('');
                        setView('dashboard');
                    } else {
                        // REJECTED : NO DB WRITE. Show manual copy screen.
                        setView('pending_approval');
                    }
                } else { setLoginError('Identifiants incorrects'); }
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setView('login');
                setLoginForm({ username: '', password: '' });
                setSearchQuery('');
                setActiveTab('search');
            };

            const openFile = async (path, name) => {
                if (!path) { showToast("Chemin du fichier introuvable.", 'error'); return; }
                setIsFileLoading(true);
                setViewingFile(null);
                setPdfState({ pdfDoc: null, pageNum: 1, numPages: 0, scale: 1.0 });
                try {
                    const rawBlob = await dbxDownloadFile(dbxConfig, setDbxConfig, path);
                    const safeName = name || "Document";
                    const pathIsPdf = path && path.toLowerCase().endsWith('.pdf');
                    const nameIsPdf = safeName.toLowerCase().endsWith('.pdf');
                    const isPdf = pathIsPdf || nameIsPdf;
                    const typedBlob = new Blob([rawBlob], { type: isPdf ? 'application/pdf' : rawBlob.type });
                    const url = URL.createObjectURL(typedBlob);
                    setViewingFile({ url, name: safeName, type: isPdf ? 'pdf' : 'image' });
                    if (isPdf) {
                        try {
                            const loadingTask = window.pdfjsLib.getDocument(url);
                            const loadedPdf = await loadingTask.promise;
                            setPdfState(prev => ({ ...prev, pdfDoc: loadedPdf, numPages: loadedPdf.numPages, pageNum: 1 }));
                        } catch(pdfErr) { showToast("Erreur lecture PDF interne.", 'error'); }
                    }
                } catch(e) { showToast("Erreur ouverture : " + e.message, 'error'); } finally { setIsFileLoading(false); }
            };

            useEffect(() => {
                let renderTask = null; // Variable pour stocker la tâche de rendu en cours

                const renderPage = async () => {
                    if (!viewingFile || viewingFile.type !== 'pdf' || !pdfState.pdfDoc || !canvasRef.current) return;
                    
                    try {
                        const page = await pdfState.pdfDoc.getPage(pdfState.pageNum);
                        const viewport = page.getViewport({ scale: pdfState.scale });
                        const canvas = canvasRef.current;
                        const context = canvas.getContext('2d');
                        
                        // Ajuster les dimensions
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        // Annuler le rendu précédent si existant (pour éviter les conflits)
                        if (renderTask) {
                            renderTask.cancel();
                        }

                        // Lancer le nouveau rendu
                        renderTask = page.render({ canvasContext: context, viewport });
                        await renderTask.promise;
                    } catch (e) {
                        // Ignorer l'erreur d'annulation (normale)
                        if (e.name !== 'RenderingCancelledException') {
                            console.error("Erreur rendu PDF:", e);
                        }
                    }
                };

                renderPage();

                // Nettoyage lors du démontage ou changement de page
                return () => {
                    if (renderTask) {
                        renderTask.cancel();
                    }
                };
            }, [pdfState.pdfDoc, pdfState.pageNum, pdfState.scale, viewingFile]);

            const changePage = (offset) => setPdfState(prev => ({ ...prev, pageNum: Math.min(Math.max(1, prev.pageNum + offset), prev.numPages) }));
            const zoomPdf = (delta) => setPdfState(prev => ({ ...prev, scale: Math.max(0.5, prev.scale + delta) }));
            
            const closeViewer = () => {
                if(viewingFile?.url) URL.revokeObjectURL(viewingFile.url);
                setViewingFile(null);
                setPdfState({ pdfDoc: null, pageNum: 1, numPages: 0, scale: 1.0 });
            };

            const handleUploadFiche = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);
                try {
                    // 1. Upload du fichier PDF (Physique) - CA C'EST OK POUR TOUT LE MONDE
                    const targetPath = `${dbxConfig.pathFT || '/Fiches'}/${file.name}`;
                    await dbxUploadFile(dbxConfig, setDbxConfig, targetPath, file);
                    
                    // 2. Si ADMIN : On met à jour l'index de manière sécurisée
                    if (currentUser.role === 'admin') {
                        await secureCloudUpdate(currentData => {
                            const newFiche = { 
                                id: 'local_' + Date.now(), 
                                name: file.name, 
                                path: targetPath, 
                                type: 'ft', 
                                server_modified: new Date().toISOString(), 
                                index_date: new Date().toLocaleString() 
                            };
                            return {
                                ...currentData,
                                fiches: [newFiche, ...(currentData.fiches || [])]
                            };
                        });
                    } 

                    showToast(`Fichier envoyé ! ${currentUser.role !== 'admin' ? "(Attente sync admin)" : ""}`, 'success');
                } catch (err) { 
                    showToast("Erreur : " + err.message, 'error'); 
                } finally { 
                    setIsUploading(false); 
                    if(uploadInputRef.current) uploadInputRef.current.value = ''; 
                }
            };

            // ... (analyzePDF unchanged)
            const analyzePDF = async (blob, filename) => {
                const pdfjsLib = window.pdfjsLib;
                try {
                    const arrayBuffer = await blob.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let allProducts = [];
                    let extractedDate = "Non daté";
                    const filenameDate = extractDateFromFilename(filename);
                    const maxPages = Math.min(pdf.numPages, 20); // Augmenté la limite de pages
                    
                    for (let i = 1; i <= maxPages; i++) {
                        // Feedback console pour debug
                        console.log(`Analyse page ${i}/${maxPages}...`);
                        
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: ctx, viewport }).promise;
                        const base64Img = canvas.toDataURL('image/png').split(',')[1];
                        
                        const instructionPrix = "ATTENTION : Les prix sur le document utilisent le format EUROPEEN (ex: 1.000,00 = mille). Le POINT (.) est un séparateur de milliers et la VIRGULE (,) est la décimale. DANS LE JSON, convertis ces prix en NOMBRE FLOTTANT STANDARD (ex: 1000.00, sans séparateur de milliers).";
                        
                        let prompt = i === 1 
                            ? `Analyse page ${i}. Cherche date (format JJ/MM/AAAA) sinon "${filenameDate}". ${instructionPrix} IMPORTANT: 1. Si un produit a un astérisque (*) avant ou après son nom, GARDE-LE dans le champ "name". 2. CRITIQUE : Le conditionnement (ex: 25Kg, 5L, Sac, Pot, Bidon, 1L) DOIT être extrait dans le champ 'packaging'. Si un produit existe en plusieurs tailles, génère plusieurs entrées distinctes. Format JSON STRICT requis: { "date_tarif": "...", "products": [ {"name": "...", "price": 0.00, "unit": "...", "packaging": "..."} ] }` 
                            : `Analyse page ${i}. ${instructionPrix} IMPORTANT: 1. Astérisque (*) dans "name". 2. CRITIQUE : Extrais le conditionnement (ex: 25Kg, 5L, Sac, Pot) dans le champ 'packaging'. C'est ce qui différencie les produits. Format JSON STRICT requis: { "products": [ {"name": "...", "price": 0.00, "unit": "...", "packaging": "..."} ] }`;
                        
                        if (i > 1) await delay(2500); // Pause plus longue entre les pages
                        
                        try {
                            const result = await callIA({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64Img } } ] }], generationConfig: { responseMimeType: "application/json" } }, dbxConfig.geminiKey);
                            const textRaw = result.candidates[0].content.parts[0].text;
                            const pageData = JSON.parse(extractJSON(textRaw));
                            
                            if (i === 1 && pageData.date_tarif) extractedDate = pageData.date_tarif;
                            
                            // Support robuste pour Array ou Object
                            if (Array.isArray(pageData)) {
                                allProducts = [...allProducts, ...pageData];
                            } else if (pageData.products && Array.isArray(pageData.products)) {
                                allProducts = [...allProducts, ...pageData.products];
                            }
                        } catch (pageErr) { 
                            console.warn(`Erreur page ${i}:`, pageErr);
                        }
                    }
                    return { date_tarif: extractedDate, products: allProducts };
                } catch (e) { 
                    console.error("Erreur PDF:", e);
                    return { date_tarif: extractDateFromFilename(filename) || "Erreur", products: [] }; 
                }
            };

            const handleManualTarifUpload = async (e) => {
                e.preventDefault();
                const file = adminFileInputRef.current?.files[0];
                if (!file) return showToast("Veuillez sélectionner un fichier PDF.", 'warning');
                if (!dbxConfig.geminiKey) return showToast("Clé API Gemini manquante.", 'error');
                
                setSyncStatus('working');
                setSyncLog("Traitement manuel...");
                setShowAdminUploadModal(false);
                
                try {
                    const targetPath = `${dbxConfig.pathTarifs || '/Tarifs'}/${file.name}`;
                    const uploadMeta = await dbxUploadFile(dbxConfig, setDbxConfig, targetPath, file);
                    const analysis = await analyzePDF(file, file.name);
                    
                    // Utilisation de la mise à jour sécurisée
                    await secureCloudUpdate(currentData => {
                        let newTarifs = [...(currentData.tarifs || [])];
                        let report = null;
                        
                        if (adminUploadMode === 'update' && targetTarifId) {
                            const oldTarif = newTarifs.find(t => t.id === targetTarifId);
                            if (oldTarif && oldTarif.products) {
                                report = generateFluctuationReport(oldTarif.products, analysis.products);
                            }
                            newTarifs = newTarifs.filter(t => t.id !== targetTarifId);
                        } else {
                             report = generateFluctuationReport([], analysis.products);
                        }
                        
                        const docEntry = { 
                            id: uploadMeta.id, name: uploadMeta.name, path: uploadMeta.path_lower, 
                            server_modified: uploadMeta.server_modified, index_date: new Date().toLocaleString(), 
                            date_tarif: analysis.date_tarif, products: analysis.products, t4_percentage: parseFloat(t4Value) || 0,
                            report: report 
                        };
                        newTarifs.push(docEntry);
                        
                        const newHistoryEntry = { 
                            date: new Date().toLocaleString(), 
                            user: currentUser.name, 
                            action: adminUploadMode === 'new' ? `Ajout: ${file.name} (T4: ${t4Value}%)` : `MAJ: ${file.name}` 
                        };
                        
                        return {
                            ...currentData,
                            tarifs: newTarifs,
                            history: [newHistoryEntry, ...(currentData.history || [])].slice(0, 10)
                        };
                    });

                    setSyncLog(`✅ ${file.name} traité (T4: ${t4Value}%).`);
                } catch (err) { setSyncLog(`❌ Erreur: ${err.message}`); setSyncStatus('error'); } 
                finally { if (adminFileInputRef.current) adminFileInputRef.current.value = ''; }
            };

            const handleSyncFiches = async () => {
                setSyncStatus('working');
                setSyncLog("Synchronisation des Fiches Techniques...");
                try {
                    if (dbxConfig.pathFT) {
                        const listFT = await dbxListFolderFiches(dbxConfig, setDbxConfig);
                        const newFiches = listFT.entries.filter(e => e['.tag'] === 'file').map(f => ({ 
                            id: f.id, name: f.name, path: f.path_lower, type: 'ft', server_modified: f.server_modified, index_date: new Date().toLocaleString() 
                        }));
                        
                        await secureCloudUpdate(currentData => {
                            const newHistoryEntry = { date: new Date().toLocaleString(), user: currentUser.name, action: "Sync Fiches Techniques" };
                            return {
                                ...currentData,
                                fiches: newFiches,
                                history: [newHistoryEntry, ...(currentData.history || [])].slice(0, 10)
                            };
                        });

                        setSyncLog(`✅ Sync terminée : ${newFiches.length} fiches.`);
                    } else { throw new Error("Chemin des fiches non configuré."); }
                } catch(e) { setSyncLog("Erreur Sync Fiches: " + e.message); setSyncStatus('error'); }
            };

            const handleDeleteAllTarifs = () => {
                askConfirm(
                    "Suppression Totale",
                    "ATTENTION : Cela va supprimer TOUS les tarifs. Continuer ?",
                    async () => {
                        await secureCloudUpdate(currentData => {
                            const newHistoryEntry = { date: new Date().toLocaleString(), user: currentUser.name, action: "Suppression Totale des Tarifs" };
                            return {
                                ...currentData,
                                tarifs: [],
                                history: [newHistoryEntry, ...(currentData.history || [])].slice(0, 10)
                            };
                        });
                    }
                );
            };

            const handleDeleteEntry = (type, id, name) => {
                askConfirm(
                    "Confirmation",
                    `Supprimer "${name}" ?`,
                    async () => {
                        await secureCloudUpdate(currentData => {
                            const newTarifs = type === 'tarif' ? (currentData.tarifs || []).filter(t => t.id !== id) : currentData.tarifs;
                            const newFiches = type === 'fiche' ? (currentData.fiches || []).filter(f => f.id !== id) : currentData.fiches;
                            const newHistoryEntry = { date: new Date().toLocaleString(), user: currentUser.name, action: `Suppression : ${name}` };
                            return {
                                ...currentData,
                                tarifs: newTarifs,
                                fiches: newFiches,
                                history: [newHistoryEntry, ...(currentData.history || [])].slice(0, 10)
                            };
                        });
                    }
                );
            };

            const handleUserSubmit = async (e) => {
                e.preventDefault();
                const newUser = { name: userFormData.name, id: userFormData.login, pass: userFormData.pass, role: userFormData.role, searchCount: 0 };
                
                await secureCloudUpdate(currentData => {
                    let updatedUsers = [...(currentData.users || [])];
                    if (editingUserIdx !== null) {
                        updatedUsers[editingUserIdx] = { ...updatedUsers[editingUserIdx], ...newUser };
                    } else {
                        if(updatedUsers.find(u => u.id === newUser.id)) throw new Error("ID existant");
                        updatedUsers.push(newUser);
                    }
                    return { ...currentData, users: updatedUsers };
                });
                
                setUserFormData({ name: '', login: '', pass: '', role: 'viewer' });
                setEditingUserIdx(null);
            };

            const handleManualCloudSave = async () => {
                askConfirm(
                    "Mise à Jour Manuelle",
                    "ATTENTION : Cette action va écraser la base de données distante avec votre version actuelle. Utilisez cela uniquement si vous savez ce que vous faites.",
                    async () => {
                        // Ici on utilise saveToCloud "classique" car c'est un FORCE UPDATE explicite
                        await secureCloudUpdate(d => ({ ...d, tarifs, fiches, users, history: dbHistory }));
                    }
                );
            };
            
            const handleLocalExport = () => {
                const dataToExport = { exportDate: new Date().toLocaleString(), history: dbHistory, tarifs: tarifs, fiches: fiches, users: users };
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `backup_tarifiers_dbx.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            const handleApproveDevice = async (req) => {
                const newEntry = { id: req.deviceId, user: req.user, login: req.login, date: new Date().toLocaleString() };
                await secureCloudUpdate(currentData => {
                    return {
                        ...currentData,
                        authorizedDevices: [...(currentData.authorizedDevices || []), newEntry],
                        pendingRequests: (currentData.pendingRequests || []).filter(r => r.deviceId !== req.deviceId)
                    };
                });
            };

            const handleRejectDevice = async (req) => {
                if(!confirm("Rejeter cette demande ?")) return;
                await secureCloudUpdate(currentData => {
                    return {
                        ...currentData,
                        pendingRequests: (currentData.pendingRequests || []).filter(r => r.deviceId !== req.deviceId)
                    };
                });
            };

            const handleRevokeDevice = async (devEntry) => {
                if(!confirm("Bloquer cet appareil ?")) return;
                const targetId = typeof devEntry === 'string' ? devEntry : devEntry.id;
                await secureCloudUpdate(currentData => {
                    return {
                        ...currentData,
                        authorizedDevices: (currentData.authorizedDevices || []).filter(d => (typeof d === 'string' ? d : d.id) !== targetId)
                    };
                });
            };

            const handleManualAddDevice = async () => {
                if(!manualAddId || !manualAddName) return showToast("Veuillez remplir ID et Nom", "warning");
                const newEntry = { id: manualAddId, user: manualAddName, login: 'Ajout Manuel', date: new Date().toLocaleString() };
                await secureCloudUpdate(currentData => {
                    return {
                        ...currentData,
                        authorizedDevices: [...(currentData.authorizedDevices || []), newEntry]
                    };
                });
                setManualAddId('');
                setManualAddName('');
            };

            // ... (rest of the render logic remains the same)
            const searchResults = useMemo(() => {
                if (!searchQuery || searchQuery.length < 2) return { products: [], fiches: [] };
                const q = searchQuery.toLowerCase();
                const foundProducts = [];
                (tarifs || []).forEach(t => {
                    if (t.products) t.products.forEach(p => {
                        if (p.name?.toLowerCase().includes(q)) foundProducts.push({ 
                            ...p, source: t.name, date_tarif: t.date_tarif, path: t.path, type: 'prod', t4_percentage: t.t4_percentage || 0,
                            report: t.report
                        });
                    });
                });
                const foundFiches = (fiches || []).filter(f => f.name.toLowerCase().includes(q));
                return { products: foundProducts, fiches: foundFiches };
            }, [searchQuery, tarifs, fiches]);

            // --- VIEW: PENDING APPROVAL (NEW VERSION READ ONLY) ---
            if (view === 'pending_approval') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                        <div className="max-w-md w-full bg-white p-8 rounded-3xl shadow-xl text-center animate-fade">
                            <div className="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Icon name="ShieldCheck" size={40}/>
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">Sécurisation Requise</h2>
                            <p className="text-slate-500 mb-6 text-sm">Pour des raisons de sécurité, l'accès automatique est désactivé. Veuillez communiquer l'identifiant ci-dessous à votre administrateur.</p>
                            
                            <div className="bg-slate-100 p-4 rounded-xl mb-6 text-left border border-slate-200 relative group">
                                <div className="text-xs text-slate-400 font-bold uppercase mb-1">ID APPAREIL UNIQUE</div>
                                <div className="font-mono text-sm bg-white p-3 rounded border border-slate-200 break-all select-all text-slate-700">{deviceId}</div>
                                <button onClick={() => { copyToClipboard(deviceId); showToast("ID Copié !", "success"); }} className="absolute top-8 right-2 bg-blue-600 text-white p-1.5 rounded hover:bg-blue-700 transition-colors" title="Copier"><Icon name="Copy" size={14}/></button>
                            </div>
                            
                            <div className="flex gap-2 justify-center">
                                <a href={`mailto:?subject=Demande Acces App&body=Voici mon ID appareil : ${deviceId}`} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-200 flex items-center gap-2"><Icon name="Mail" size={16}/> Envoyer Email</a>
                                <button onClick={() => { copyToClipboard(deviceId); window.location.href=`whatsapp://send?text=Voici mon ID pour l'application : ${deviceId}`; }} className="px-4 py-2 bg-green-50 text-green-600 border border-green-100 rounded-xl text-sm font-bold hover:bg-green-100 flex items-center gap-2"><Icon name="MessageCircle" size={16}/> WhatsApp</button>
                            </div>

                            <button onClick={() => setView('login')} className="mt-8 text-blue-600 font-bold hover:underline text-sm">Retour à la connexion</button>
                        </div>
                    </div>
                );
            }

            // --- VIEW: LOGIN ---
            if (view === 'login') return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="fixed top-4 right-4 z-[200] space-y-2">
                        {toasts.map(t => (
                            <div key={t.id} className={`p-4 rounded-xl shadow-lg text-sm font-bold animate-fade text-white flex items-center gap-2 ${t.type === 'error' ? 'bg-red-500' : t.type === 'success' ? 'bg-green-500' : 'bg-slate-800'}`}>
                                <Icon name={t.type === 'error' ? 'AlertCircle' : t.type === 'success' ? 'Check' : 'Info'} size={16}/>
                                {t.message}
                            </div>
                        ))}
                    </div>

                    {showConfigModal && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full animate-fade">
                                <h2 className="text-xl font-bold mb-2">Configuration Initiale</h2>
                                <p className="text-slate-500 text-sm mb-6">Token manquant ou expiré.</p>
                                <input type="password" placeholder="Token Dropbox..." className="w-full p-3 border rounded-xl mb-4 text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500" value={dbxConfig.token} onChange={e => setDbxConfig({...dbxConfig, token: e.target.value})} />
                                <button onClick={() => { if(dbxConfig.token) { setShowConfigModal(false); loadCloudDatabase(); } }} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Valider</button>
                            </div>
                        </div>
                    )}
                    <div className="w-full max-w-md p-8 bg-white/80 backdrop-blur-xl rounded-3xl shadow-xl border border-white/50 animate-fade relative">
                        {syncStatus === 'working' && <div className="absolute top-4 right-4 flex items-center gap-2 text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-full animate-pulse"><Icon name="Loader2" size={14} className="animate-spin"/> Sync...</div>}
                        <div className="text-center mb-8">
                            <div className="inline-flex p-3 bg-blue-600 rounded-2xl shadow-lg shadow-blue-200 mb-4"><Icon name="Database" size={32} className="text-white"/></div>
                            <h1 className="text-3xl font-black text-slate-800 mb-1">Catalogue <span className="text-blue-600">DBX V2</span></h1>
                            <p className="text-slate-500 font-medium text-sm">Portail Unifié</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            {syncStatus === 'error' && <div className="bg-red-50 text-red-500 p-3 rounded-xl text-xs text-center font-bold border border-red-100 flex flex-col items-center gap-1"><span>⚠️ {syncLog}</span><button type="button" onClick={() => setShowConfigModal(true)} className="underline text-red-700 hover:text-red-900 mt-1">Configurer le token</button></div>}
                            {loginError && <div className="bg-red-50 text-red-500 p-3 rounded-xl text-sm text-center font-bold border border-red-100">{loginError}</div>}
                            <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-700" value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} placeholder="Identifiant" />
                            <input type="password" className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-700" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} placeholder="Mot de passe" />
                            <button className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition-all transform active:scale-95 mt-2">Se Connecter</button>
                        </form>
                        <div className="mt-6 pt-4 border-t border-slate-200 text-center"><button type="button" onClick={() => loadCloudDatabase(false)} className="text-xs font-bold text-slate-400 hover:text-blue-600 flex items-center justify-center gap-2 w-full transition-colors"><Icon name="RefreshCw" size={12}/> Mettre à jour les accès (Cloud)</button></div>
                        {!HARDCODED_DBX_TOKEN && <p className="text-xs text-center text-red-400 mt-4">⚠️ Token Dropbox manquant.</p>}
                    </div>
                </div>
            );

            // --- VIEW: DASHBOARD (APP) ---
            return (
                <ErrorBoundary>
                    <div className="min-h-screen flex flex-col bg-slate-50 text-slate-900 font-sans relative">
                        <div className="fixed top-20 right-4 z-[200] space-y-2 pointer-events-none">
                            {toasts.map(t => (
                                <div key={t.id} className={`p-4 rounded-xl shadow-lg text-sm font-bold animate-fade text-white flex items-center gap-2 pointer-events-auto ${t.type === 'error' ? 'bg-red-500' : t.type === 'success' ? 'bg-green-500' : 'bg-slate-800'}`}>
                                    <Icon name={t.type === 'error' ? 'AlertCircle' : t.type === 'success' ? 'Check' : 'Info'} size={16}/>
                                    {t.message}
                                </div>
                            ))}
                        </div>

                        {confirmModal.show && (
                             <div className="fixed inset-0 z-[150] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade">
                                <div className="bg-white p-6 rounded-3xl shadow-2xl max-w-sm w-full text-center">
                                    <div className="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Icon name="HelpCircle" size={24}/>
                                    </div>
                                    <h3 className="text-lg font-bold text-slate-800 mb-2">{confirmModal.title}</h3>
                                    <p className="text-sm text-slate-500 mb-6">{confirmModal.message}</p>
                                    <div className="flex gap-3">
                                        <button onClick={() => setConfirmModal({...confirmModal, show: false})} className="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition-colors">Annuler</button>
                                        <button onClick={handleConfirmYes} className="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors">Confirmer</button>
                                    </div>
                                </div>
                             </div>
                        )}
                        
                        {showSavedQuotesModal && (
                            <div className="fixed inset-0 z-[140] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade">
                                <div className="bg-white rounded-3xl shadow-2xl max-w-2xl w-full h-[70vh] flex flex-col relative overflow-hidden">
                                    <button onClick={() => setShowSavedQuotesModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 z-10"><Icon name="X" size={24}/></button>
                                    <div className="p-6 bg-slate-50 border-b border-slate-200">
                                        <h3 className="font-bold text-lg mb-1 flex items-center gap-2 text-slate-800"><Icon name="Archive" /> Devis Sauvegardés</h3>
                                        <p className="text-sm text-slate-400">Retrouvez et modifiez vos devis précédents</p>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-6 space-y-3">
                                        {(!savedQuotes || savedQuotes.length === 0) ? (
                                            <div className="text-center py-10 text-slate-400 italic">Aucun devis sauvegardé.</div>
                                        ) : (
                                            savedQuotes.sort((a,b) => b.id - a.id).map(sq => (
                                                <div key={sq.id} className="bg-white border border-slate-200 p-4 rounded-xl flex justify-between items-center hover:border-blue-300 transition-colors group">
                                                    <div>
                                                        <div className="font-bold text-slate-800">{sq.client}</div>
                                                        <div className="text-xs text-slate-500 flex items-center gap-2">
                                                            <span>{sq.saveDate}</span>
                                                            <span className="bg-slate-100 px-1.5 rounded text-[10px]">{(sq.items || []).length} articles</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleLoadQuote(sq)} className="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-100 transition-colors">Charger</button>
                                                        {currentUser?.role === 'admin' && (
                                                            <button onClick={() => handleDeleteSavedQuote(sq.id)} className="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-red-100 transition-colors"><Icon name="Trash2" size={14}/></button>
                                                        )}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {isFileLoading && <div className="fixed inset-0 z-[110] bg-white/50 backdrop-blur-sm flex items-center justify-center animate-fade"><div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center border border-slate-100"><div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div><div className="font-bold text-slate-800">Chargement...</div></div></div>}
                        
                        {calcState.show && (
                            <div className="fixed inset-0 z-[120] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade">
                                <div className="bg-white p-6 rounded-3xl shadow-2xl max-w-sm w-full relative">
                                    <button onClick={() => setCalcState({ ...calcState, show: false })} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="X"/></button>
                                    <h3 className="font-bold text-lg mb-1 flex items-center gap-2"><Icon name="Calculator" className="text-blue-600"/> Calculatrice</h3>
                                    <p className="text-xs text-slate-500 mb-6 truncate">{calcState.product.name}</p>
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-slate-500">Base ({calcState.baseLabel})</span>
                                            <span className="font-bold text-slate-700">{calcState.basePrice.toFixed(2)} DH</span>
                                        </div>
                                        <div className="flex items-center gap-2 mt-3">
                                            <div className="grow">
                                                <label className="text-[10px] font-bold uppercase text-slate-400 block mb-1">Remise Suppl. (%)</label>
                                                <input type="number" min="0" max="100" autoFocus className="w-full p-2 border rounded-lg text-lg font-bold text-center outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" value={extraDiscount} onChange={e => setExtraDiscount(e.target.value)} />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-xs text-slate-400 font-bold uppercase mb-1">Prix Final</div>
                                        <div className="text-4xl font-black text-blue-600 tracking-tight">
                                            {(calcState.basePrice * (1 - (parseFloat(extraDiscount)||0)/100)).toFixed(2)} <span className="text-sm">DH</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showQuoteProductModal && (
                            <div className="fixed inset-0 z-[130] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade">
                                <div className="bg-white rounded-3xl shadow-2xl max-w-2xl w-full h-[80vh] flex flex-col relative overflow-hidden">
                                    <button onClick={() => setShowQuoteProductModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 z-10"><Icon name="X" size={24}/></button>
                                    <div className="p-6 bg-slate-50 border-b border-slate-200">
                                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800"><Icon name="Search" /> Ajouter un produit au devis</h3>
                                        <input autoFocus className="w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Rechercher un produit..." value={quoteSearchQuery} onChange={e => setQuoteSearchQuery(e.target.value)} />
                                    </div>
                                    
                                    <div className="flex-1 overflow-y-auto p-6 space-y-2">
                                        {selectedProductForQuote ? (
                                            <div className="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div>
                                                        <h4 className="font-bold text-lg text-slate-800">{selectedProductForQuote.name}</h4>
                                                        <p className="text-sm text-slate-500">{selectedProductForQuote.packaging}</p>
                                                    </div>
                                                    <button onClick={() => setSelectedProductForQuote(null)} className="text-sm text-blue-600 underline">Changer</button>
                                                </div>
                                                
                                                {selectedProductForQuote.t4_percentage > 0 && (
                                                    <div className="mb-4 bg-orange-50 text-orange-700 px-3 py-2 rounded-lg text-xs font-bold border border-orange-100 flex items-center gap-2">
                                                        <Icon name="Percent" size={12}/> Tarif T4 appliqué automatiquement (-{selectedProductForQuote.t4_percentage}%)
                                                    </div>
                                                )}

                                                <div className="grid grid-cols-2 gap-4 mb-4">
                                                    <div>
                                                        <label className="text-xs font-bold uppercase text-slate-500 block mb-1">Prix Unitaire (Base)</label>
                                                        <input type="number" step="0.01" className="w-full p-2 border rounded-lg" value={quoteItemForm.price} onChange={e => setQuoteItemForm({...quoteItemForm, price: parseFloat(e.target.value)})} />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold uppercase text-slate-500 block mb-1">Quantité</label>
                                                        <input type="number" min="1" className="w-full p-2 border rounded-lg" value={quoteItemForm.qty} onChange={e => setQuoteItemForm({...quoteItemForm, qty: parseFloat(e.target.value)})} />
                                                    </div>
                                                </div>

                                                <div className="mb-4">
                                                    <label className="text-xs font-bold uppercase text-slate-500 block mb-1">Remise / Majoration</label>
                                                    <div className="flex gap-2">
                                                        <input type="number" step="0.1" className="flex-1 p-2 border rounded-lg" placeholder="Valeur (ex: 10 ou -10)" value={quoteItemForm.discountVal} onChange={e => setQuoteItemForm({...quoteItemForm, discountVal: parseFloat(e.target.value)})} />
                                                        <select className="p-2 border rounded-lg bg-white" value={quoteItemForm.discountType} onChange={e => setQuoteItemForm({...quoteItemForm, discountType: e.target.value})}>
                                                            <option value="percent">%</option>
                                                            <option value="amount">DH</option>
                                                        </select>
                                                    </div>
                                                    <p className="text-[10px] text-slate-400 mt-1">Valeur positive = Remise. Valeur négative (ex: -10) = Majoration.</p>
                                                </div>

                                                {/* NOUVEAU : Affichage Prix Net Instantané */}
                                                <div className="bg-slate-100 p-3 rounded-xl border border-slate-200 mb-4 flex justify-between items-center">
                                                    <span className="text-xs font-bold text-slate-500 uppercase">Prix Net Unitaire</span>
                                                    <span className="font-bold text-lg text-slate-700">
                                                        {(() => {
                                                            let p = quoteItemForm.price;
                                                            if(quoteItemForm.discountType === 'percent') p = p * (1 - quoteItemForm.discountVal/100);
                                                            else p = p - quoteItemForm.discountVal;
                                                            return p.toFixed(2);
                                                        })()} DH
                                                    </span>
                                                </div>

                                                <div className="flex justify-between items-center bg-white p-3 rounded-xl border border-blue-100 mb-4">
                                                    <span className="font-bold text-slate-500">Total Ligne HT</span>
                                                    <span className="font-black text-xl text-blue-600">
                                                        {(() => {
                                                            let p = quoteItemForm.price;
                                                            if(quoteItemForm.discountType === 'percent') p = p * (1 - quoteItemForm.discountVal/100);
                                                            else p = p - quoteItemForm.discountVal;
                                                            return (p * quoteItemForm.qty).toFixed(2);
                                                        })()} DH
                                                    </span>
                                                </div>

                                                <button onClick={addQuoteItem} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors">Valider l'ajout</button>
                                            </div>
                                        ) : (
                                            (quoteSearchResults || []).length === 0 ? (
                                                <div className="text-center text-slate-400 py-10">Commencez à taper pour rechercher...</div>
                                            ) : (
                                                (quoteSearchResults || []).map((p, i) => (
                                                    <div key={i} onClick={() => selectProductForQuote(p)} className="p-3 bg-white border border-slate-100 rounded-xl hover:border-blue-400 cursor-pointer flex justify-between items-center group transition-all">
                                                        <div>
                                                            <div className="font-bold text-slate-700">{p.name}</div>
                                                            <div className="text-xs text-slate-400">{p.packaging} • {p.source}</div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="font-bold text-green-600">{p.price}</div>
                                                            {p.t4_percentage > 0 && <div className="text-[10px] font-bold text-orange-500 bg-orange-50 px-1 rounded">T4: -{p.t4_percentage}%</div>}
                                                        </div>
                                                    </div>
                                                ))
                                            )
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {viewingReport && (
                            <div className="fixed inset-0 z-[120] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade">
                                <div className="bg-white rounded-3xl shadow-2xl max-w-3xl w-full relative flex flex-col max-h-[85vh] overflow-hidden">
                                    <div className="bg-slate-900 text-white p-6 relative">
                                        <button onClick={() => setViewingReport(null)} className="absolute top-6 right-6 text-slate-400 hover:text-white"><Icon name="X" size={24}/></button>
                                        <h3 className="font-black text-2xl mb-1 flex items-center gap-3"><Icon name="TrendingUp" className="text-blue-400"/> Rapport de Fluctuation</h3>
                                        <p className="text-sm text-slate-400 font-mono opacity-80">Mise à jour du : {viewingReport.date}</p>
                                    </div>
                                    <div className="grid grid-cols-3 gap-1 p-1 bg-slate-100">
                                        <div className="bg-white p-4 text-center">
                                            <div className="text-2xl font-black text-orange-600">{viewingReport.changed.length}</div>
                                            <div className="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Modifiés</div>
                                        </div>
                                        <div className="bg-white p-4 text-center">
                                            <div className="text-2xl font-black text-green-600">{viewingReport.added.length}</div>
                                            <div className="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Ajoutés</div>
                                        </div>
                                        <div className="bg-white p-4 text-center">
                                            <div className="text-2xl font-black text-red-600">{viewingReport.removed.length}</div>
                                            <div className="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Retirés</div>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-6 space-y-8 modern-scroll bg-slate-50">
                                        {viewingReport.changed.length > 0 && (
                                            <div>
                                                <h4 className="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-orange-500"></div> Prix Modifiés</h4>
                                                <div className="grid grid-cols-1 gap-3">
                                                    {viewingReport.changed.map((item, idx) => (
                                                        <div key={idx} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                                                            <div>
                                                                <div className="font-bold text-slate-800 text-sm">{item.name}</div>
                                                                {item.packaging && <div className="inline-block mt-1 bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded-md uppercase tracking-wide">{item.packaging}</div>}
                                                            </div>
                                                            <div className="flex items-center gap-4 text-sm">
                                                                <div className="text-right">
                                                                    <div className="text-slate-400 line-through text-xs">{item.oldPrice}</div>
                                                                    <div className="font-bold text-slate-800">{item.newPrice} <span className="text-[10px] text-slate-400">{item.unit}</span></div>
                                                                </div>
                                                                <div className={`flex items-center gap-1 px-2 py-1 rounded-lg font-bold text-xs ${item.diff > 0 ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>
                                                                    {item.diff > 0 ? <Icon name="TrendingUp" size={14}/> : <Icon name="TrendingDown" size={14}/>}
                                                                    {item.diff > 0 ? '+' : ''}{item.diff}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        {viewingReport.added.length > 0 && (
                                            <div>
                                                <h4 className="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-green-500"></div> Nouveaux Articles</h4>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                    {viewingReport.added.map((item, idx) => (
                                                        <div key={idx} className="bg-white p-3 rounded-xl border border-green-100 shadow-sm flex justify-between items-center">
                                                            <div>
                                                                <div className="font-bold text-slate-700 text-sm truncate max-w-[150px]">{item.name}</div>
                                                                {item.packaging && <div className="inline-block mt-0.5 bg-indigo-50 text-indigo-600 text-[10px] font-bold px-1.5 rounded uppercase">{item.packaging}</div>}
                                                            </div>
                                                            <div className="font-black text-green-600 text-sm">{item.price} <span className="text-[10px] text-green-400">{item.unit}</span></div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        {viewingReport.removed.length > 0 && (
                                            <div>
                                                <h4 className="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-red-500"></div> Articles Retirés</h4>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 opacity-60">
                                                    {viewingReport.removed.map((item, idx) => (
                                                        <div key={idx} className="bg-white p-3 rounded-xl border border-red-100 flex justify-between items-center">
                                                            <div>
                                                                <div className="font-medium text-slate-700 text-sm line-through decoration-red-400">{item.name}</div>
                                                                {item.packaging && <div className="text-[10px] text-slate-400">{item.packaging}</div>}
                                                            </div>
                                                            <div className="text-slate-400 text-xs line-through">{item.price}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        {viewingReport.changed.length === 0 && viewingReport.added.length === 0 && viewingReport.removed.length === 0 && (
                                            <div className="text-center py-12">
                                                <div className="inline-flex bg-slate-100 p-4 rounded-full text-slate-300 mb-3"><Icon name="CheckCircle" size={32}/></div>
                                                <div className="text-slate-500 font-medium">Aucun changement détecté lors de cette mise à jour.</div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {viewingFile && (
                            <div className="fixed inset-0 z-[100] bg-slate-900 flex flex-col animate-fade">
                                <div className="flex items-center justify-between p-4 bg-slate-900 text-white border-b border-slate-700 shadow-xl z-20">
                                    <h3 className="font-bold truncate max-w-md flex items-center gap-2 text-sm md:text-base"><Icon name="FileText" size={18} className="text-blue-400"/> {viewingFile.name}</h3>
                                    <div className="flex gap-2 items-center">
                                        {viewingFile.type === 'pdf' && pdfState.numPages > 1 && (<div className="hidden md:flex bg-slate-800 rounded-lg p-1 mr-2 items-center"><button onClick={() => changePage(-1)} className="p-1 hover:text-blue-400"><Icon name="ChevronLeft"/></button><span className="px-2 text-xs font-mono">{pdfState.pageNum} / {pdfState.numPages}</span><button onClick={() => changePage(1)} className="p-1 hover:text-blue-400"><Icon name="ChevronRight"/></button></div>)}
                                        {viewingFile.type === 'pdf' && (<div className="hidden md:flex bg-slate-800 rounded-lg p-1 mr-2"><button onClick={() => zoomPdf(-0.2)} className="p-1 hover:text-blue-400"><Icon name="Minus" size={16}/></button><button onClick={() => zoomPdf(0.2)} className="p-1 hover:text-blue-400"><Icon name="Plus" size={16}/></button></div>)}
                                        <a href={viewingFile.url} download={viewingFile.name} className="p-2 bg-slate-800 hover:bg-blue-600 rounded-lg text-slate-300 hover:text-white transition-colors" title="Sauvegarder"><Icon name="Download" size={18}/></a>
                                        <button onClick={closeViewer} className="p-2 bg-red-600 hover:bg-red-700 rounded-lg text-white transition-colors" title="Fermer"><Icon name="X" size={18}/></button>
                                    </div>
                                </div>
                                <div className="flex-1 relative bg-gray-800 overflow-auto flex justify-center p-4">
                                    {viewingFile.type === 'pdf' ? (<div className="relative shadow-2xl"><canvas ref={canvasRef} className="max-w-full h-auto bg-white"/>{pdfState.numPages > 1 && (<div className="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-4 py-2 rounded-full flex gap-4 items-center shadow-xl backdrop-blur-sm border border-slate-700"><button onClick={() => changePage(-1)}><Icon name="ChevronLeft"/></button><span className="text-xs font-bold">{pdfState.pageNum}/{pdfState.numPages}</span><button onClick={() => changePage(1)}><Icon name="ChevronRight"/></button></div>)}</div>) : (<img src={viewingFile.url} alt="Visuel" className="max-w-full max-h-full object-contain" />)}
                                </div>
                            </div>
                        )}

                        <nav className="bg-white/80 backdrop-blur-md border-b border-slate-200 h-16 flex items-center justify-between px-4 md:px-8 sticky top-0 z-40">
                            <div className="flex items-center gap-3"><div className="flex items-center gap-2 cursor-pointer" onClick={() => setActiveTab('search')}><div className="bg-blue-600 text-white p-1.5 rounded-lg"><Icon name="Database" size={20} /></div><span className="font-bold text-lg tracking-tight hidden md:inline">Catalogue <span className="text-blue-600">DBX V2</span></span></div><button onClick={() => loadCloudDatabase()} className="p-2 bg-slate-100 hover:bg-blue-100 text-slate-500 hover:text-blue-600 rounded-full transition-colors" title="Forcer la mise à jour"><Icon name="RefreshCw" size={16} className={syncStatus === 'working' ? 'animate-spin' : ''}/></button></div>
                            <div className="flex items-center gap-3">
                                {currentUser.role === 'admin' && (<div className="flex bg-slate-100 p-1 rounded-xl overflow-x-auto max-w-[200px] md:max-w-none no-scrollbar"><button onClick={() => setActiveTab('search')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${activeTab === 'search' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Recherche</button><button onClick={() => setActiveTab('quote')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${activeTab === 'quote' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Devis</button><button onClick={() => setActiveTab('onssa')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${activeTab === 'onssa' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>ONSSA</button><button onClick={() => setActiveTab('admin')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${activeTab === 'admin' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Admin</button><button onClick={() => setActiveTab('security')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1 whitespace-nowrap ${activeTab === 'security' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Sécurité {pendingRequests.length > 0 && <span className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>}</button><button onClick={() => setActiveTab('users')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${activeTab === 'users' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Users</button></div>)}
                                {currentUser.role !== 'admin' && (<div className="flex bg-slate-100 p-1 rounded-xl overflow-x-auto max-w-[200px] md:max-w-none no-scrollbar"><button onClick={() => setActiveTab('search')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${activeTab === 'search' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Recherche</button><button onClick={() => setActiveTab('quote')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${activeTab === 'quote' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>Devis</button></div>)}
                                <div className="h-8 w-px bg-slate-200 mx-1"></div><button onClick={handleLogout} className="flex items-center gap-2 text-slate-500 hover:text-red-600 transition-colors text-sm font-medium"><span className="hidden md:inline">{currentUser.name}</span><Icon name="LogOut" size={18} /></button>
                            </div>
                        </nav>

                        <main className="flex-1 max-w-6xl w-full mx-auto p-4 md:p-8">
                            
                            {/* SEARCH & QUOTE TABS (UNCHANGED BUT INCLUDED FOR CONTEXT) */}
                            {activeTab === 'search' && (
                                <div className="animate-fade">
                                    {dbMeta && <div className="bg-blue-50 border border-blue-100 rounded-lg px-4 py-2 mb-6 flex justify-between items-center text-xs text-blue-800 animate-fade"><div className="flex gap-4"><span className="font-bold flex items-center gap-1"><Icon name="Clock" size={12}/> MAJ: {dbMeta.date}</span><span className="hidden md:inline">|</span><span className="flex items-center gap-1"><Icon name="User" size={12}/> {dbMeta.user}</span></div><div className="italic opacity-75 hidden md:block">Données synchronisées automatiquement</div></div>}
                                    {dbHistory.length > 0 && <div className="bg-slate-900 text-white py-2 px-4 rounded-lg mb-6 shadow-md border border-slate-700 overflow-hidden relative"><div className="absolute left-0 top-0 bottom-0 bg-gradient-to-r from-slate-900 to-transparent w-10 z-10"></div><div className="absolute right-0 top-0 bottom-0 bg-gradient-to-l from-slate-900 to-transparent w-10 z-10"></div><div className="marquee-container"><div className="marquee-content flex gap-8">{(dbHistory || []).map((h, i) => (<span key={i} className="inline-flex items-center gap-2 text-xs font-mono"><span className="text-blue-400">[{h.date}]</span><span className="font-bold text-yellow-400">{h.user}</span>:<span>{h.action}</span><span className="text-slate-600 mx-2">|</span></span>))}</div></div></div>}
                                    
                                    {/* NOUVELLE DISPOSITION : Grid 4 colonnes (3 pour Rapports, 1 pour Stats) */}
                                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                                        {/* SECTION RAPPORTS (Elargie) */}
                                        <div className="lg:col-span-3 bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                                            <h3 className="text-xs font-bold uppercase text-slate-400 mb-4 flex items-center gap-2"><Icon name="BellRing" size={14}/> Dernières Mises à Jour & Rapports</h3>
                                            <div className="space-y-3 max-h-80 overflow-y-auto pr-2 custom-scrollbar">
                                                {(tarifs || [])
                                                    .filter(t => t.report && (t.report.changed.length > 0 || t.report.added.length > 0 || t.report.removed.length > 0))
                                                    // FIX SORTING: Use server_modified (ISO) for reliable sorting, fallback to index_date if missing
                                                    .sort((a, b) => {
                                                        const dateA = new Date(a.server_modified || a.index_date || 0);
                                                        const dateB = new Date(b.server_modified || b.index_date || 0);
                                                        return dateB - dateA;
                                                    })
                                                    .slice(0, 10) // Afficher un peu plus d'éléments vu qu'on a de la place
                                                    .map((t, i) => (
                                                    <div key={i} className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100 hover:bg-blue-50 transition-colors group">
                                                        <div className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center font-bold text-blue-600 shrink-0 shadow-sm group-hover:scale-110 transition-transform"><Icon name="FileText" size={18}/></div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-bold text-slate-700 text-sm truncate flex items-center gap-2">
                                                                {t.name}
                                                                {/* Badges pour résumer le contenu du rapport */}
                                                                <div className="flex gap-1">
                                                                    {t.report.changed.length > 0 && <span className="bg-orange-100 text-orange-700 text-[9px] px-1.5 rounded-full font-bold">Modif: {t.report.changed.length}</span>}
                                                                    {t.report.added.length > 0 && <span className="bg-green-100 text-green-700 text-[9px] px-1.5 rounded-full font-bold">Ajout: {t.report.added.length}</span>}
                                                                </div>
                                                            </div>
                                                            <div className="text-xs text-slate-400 flex items-center gap-1"><Icon name="Clock" size={10}/> {t.index_date}</div>
                                                        </div>
                                                        <button onClick={() => setViewingReport(t.report)} className="px-4 py-2 bg-white text-blue-600 text-xs font-bold rounded-lg border border-blue-100 hover:bg-blue-600 hover:text-white transition-all shrink-0 shadow-sm flex items-center gap-2">
                                                            <Icon name="Eye" size={12}/> Ouvrir
                                                        </button>
                                                    </div>
                                                ))}
                                                {(tarifs || []).filter(t => t.report && (t.report.changed.length > 0 || t.report.added.length > 0 || t.report.removed.length > 0)).length === 0 && (
                                                    <div className="text-center text-slate-400 py-10 flex flex-col items-center">
                                                        <div className="bg-slate-50 p-4 rounded-full mb-3"><Icon name="Inbox" size={24} className="opacity-50"/></div>
                                                        <span className="text-xs italic">Aucune modification récente détectée.</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        {/* SECTION STATS (Verticale et Compacte) */}
                                        <div className="lg:col-span-1 bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex flex-col">
                                            <h3 className="text-xs font-bold uppercase text-slate-400 mb-4 flex items-center gap-2"><Icon name="PieChart" size={14}/> Données</h3>
                                            <div className="flex flex-col gap-3 flex-1">
                                                <div className="flex items-center gap-4 p-3 bg-green-50 rounded-xl border border-green-100">
                                                    <div className="p-2 bg-white rounded-lg text-green-600 shadow-sm"><Icon name="Folder" size={18}/></div>
                                                    <div>
                                                        <div className="text-2xl font-black text-green-700 leading-none">{(tarifs || []).length}</div>
                                                        <div className="text-[10px] font-bold text-green-800 uppercase tracking-wide">Tarifs</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-4 p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                                                    <div className="p-2 bg-white rounded-lg text-indigo-600 shadow-sm"><Icon name="File" size={18}/></div>
                                                    <div>
                                                        <div className="text-2xl font-black text-indigo-700 leading-none">{(fiches || []).length}</div>
                                                        <div className="text-[10px] font-bold text-indigo-800 uppercase tracking-wide">Fiches</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-4 p-3 bg-blue-50 rounded-xl border border-blue-100">
                                                    <div className="p-2 bg-white rounded-lg text-blue-600 shadow-sm"><Icon name="Box" size={18}/></div>
                                                    <div>
                                                        <div className="text-2xl font-black text-blue-700 leading-none">{(tarifs || []).reduce((acc,t)=>acc+((t.products || []).length||0),0)}</div>
                                                        <div className="text-xs font-bold text-blue-800 uppercase tracking-wide">Produits</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="max-w-3xl mx-auto text-center mb-10"><div className="relative group z-10"><input className="w-full p-5 pl-14 rounded-2xl border border-slate-200 shadow-xl shadow-slate-100 focus:ring-4 focus:ring-blue-50 outline-none text-lg font-medium transition-all" placeholder="Rechercher un produit ou une fiche..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} autoFocus /><div className="absolute left-5 top-5 text-slate-300 group-focus-within:text-blue-500 transition-colors"><Icon name="Search" size={24} /></div></div>{currentUser.role === 'admin' && (<div className="mt-4 flex justify-center"><button onClick={() => uploadInputRef.current.click()} disabled={isUploading} className="text-xs font-bold text-slate-400 hover:text-blue-600 flex items-center gap-2 transition-colors bg-slate-50 hover:bg-blue-50 px-3 py-1.5 rounded-full"><Icon name={isUploading ? "Loader2" : "UploadCloud"} size={14} className={isUploading ? "animate-spin" : ""}/>{isUploading ? "Envoi..." : "Ajouter Fiche PDF"}</button><input type="file" ref={uploadInputRef} onChange={handleUploadFiche} accept="application/pdf" className="hidden" /></div>)}</div>
                                    <div className="space-y-8 pb-20">
                                        {(searchResults.products || []).length > 0 && (
                                            <div className="animate-fade">
                                                <h3 className="text-sm font-bold uppercase text-slate-400 mb-4 pl-2 flex items-center gap-2"><Icon name="Box" size={16}/> Tarifs ({(searchResults.products || []).length})</h3>
                                                <div className="space-y-3">
                                                    {(searchResults.products || []).map((res, i) => {
                                                        const isTaxable = res.name && (res.name.trim().startsWith('*') || res.name.trim().endsWith('*'));
                                                        const priceVal = parsePrice(res.price);
                                                        const validPrice = priceVal > 0;
                                                        const priceHT = validPrice ? priceVal.toFixed(2) : res.price;
                                                        const priceTTC = validPrice ? (priceVal * 1.20).toFixed(2) : null;
                                                        const t4Rate = res.t4_percentage || 0;
                                                        const basePriceForT4 = isTaxable ? (validPrice ? priceVal * 1.20 : 0) : priceVal;
                                                        const priceT4 = validPrice ? (basePriceForT4 * (1 - t4Rate/100)).toFixed(2) : null;
                                                        const pricesObj = { ht: validPrice ? priceHT : null, ttc: isTaxable ? priceTTC : null, t4: (t4Rate > 0 && validPrice) ? priceT4 : null };
                                                        return (
                                                            <div key={i} className="bg-white p-5 rounded-2xl border border-slate-100 hover:border-blue-300 hover:shadow-lg transition-all flex flex-col md:flex-row md:items-center justify-between gap-4 group">
                                                                <div className="flex items-start gap-4"><div className="w-10 h-10 rounded-xl flex items-center justify-center shrink-0 bg-blue-50 text-blue-600"><Icon name="Tag" size={20}/></div><div><div className="font-bold text-slate-800 text-lg">{res.name}{res.packaging && <span className="ml-2 text-sm font-normal text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full">en {res.packaging}</span>}</div><div className="flex flex-wrap items-center gap-2 mt-2"><span className="bg-slate-100 px-2.5 py-1 rounded-lg text-xs font-bold text-slate-600 flex items-center gap-1"><Icon name="Folder" size={12}/> {res.source}</span><span className="px-2.5 py-1 rounded-lg text-xs font-bold flex items-center gap-1 bg-green-50 text-green-600 border border-green-100"><Icon name="Calendar" size={12}/> {res.date_tarif}</span>{t4Rate > 0 && <span className="px-2.5 py-1 rounded-lg text-xs font-bold flex items-center gap-1 bg-orange-50 text-orange-600 border border-orange-100"><Icon name="Percent" size={12}/> T4: -{t4Rate}%</span>}</div></div></div>
                                                                <div className="flex items-center justify-between md:justify-end gap-3 pl-14 md:pl-0">
                                                                    <div className="text-right mr-4">
                                                                        {validPrice && isTaxable ? (<div className="flex flex-col items-end"><div className="text-sm font-bold text-slate-400">{priceHT} <span className="text-[10px]">HT</span></div><div className="text-xl font-bold text-slate-700 whitespace-nowrap">{priceTTC} <span className="text-xs text-slate-400 font-bold">TTC</span></div>{t4Rate > 0 && <div className="text-2xl font-black text-orange-500 whitespace-nowrap">{priceT4} <span className="text-xs text-orange-300 font-bold">T4</span></div>}</div>) : (<div className="flex flex-col items-end"><div className="text-xl font-bold text-green-600 whitespace-nowrap">{priceHT} <span className="text-xs text-green-800 font-bold">{validPrice ? 'EXO' : (res.unit || 'DH')}</span></div>{t4Rate > 0 && validPrice && <div className="text-2xl font-black text-orange-500 whitespace-nowrap">{priceT4} <span className="text-xs text-orange-300 font-bold">T4</span></div>}</div>)}
                                                                        {validPrice && <div className="text-xs text-slate-400 font-bold mt-1 text-right">{res.unit || 'DH'}</div>}
                                                                    </div>
                                                                    <div className="flex gap-2">
                                                                        {validPrice && <button onClick={() => openCalculator(res, pricesObj)} className="bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 shadow-sm" title="Calculatrice"><Icon name="Calculator" size={16}/></button>}
                                                                        {res.report && <button onClick={() => setViewingReport(res.report)} className="bg-orange-50 hover:bg-orange-100 text-orange-600 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 shadow-sm border border-orange-200" title="Consulter Différence Tarifs"><Icon name="TrendingUp" size={16}/></button>}
                                                                        <button onClick={() => openFile(res.path, res.source)} className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><Icon name="Eye" size={14}/> Voir</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                        {(searchResults.fiches || []).length > 0 && (
                                            <div className="animate-fade">
                                                <h3 className="text-sm font-bold uppercase text-slate-400 mb-4 pl-2 flex items-center gap-2 border-t pt-6 mt-6 md:border-none md:pt-0 md:mt-0"><Icon name="FileText" size={16}/> Fiches ({(searchResults.fiches || []).length})</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    {(searchResults.fiches || []).map((f, i) => (<div key={i} className="bg-white p-4 rounded-2xl border border-slate-100 hover:border-indigo-300 hover:shadow-md transition-all flex items-center justify-between group"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center shrink-0"><Icon name="FileText" size={20}/></div><div className="truncate pr-4"><div className="font-bold text-slate-700 truncate">{f.name}</div><div className="text-xs text-slate-400">PDF</div></div></div><button onClick={() => openFile(f.path, f.name)} className="p-2 text-slate-400 hover:text-indigo-600 bg-slate-50 hover:bg-indigo-50 rounded-lg transition-colors"><Icon name="Eye" size={18}/></button></div>))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'quote' && (
                                <div className="max-w-4xl mx-auto space-y-8 animate-fade">
                                    {/* ... QUOTE TAB CONTENT (KEPT AS IS) ... */}
                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="font-bold text-lg flex items-center gap-2"><Icon name="FileEdit" /> Créer un Devis</h3>
                                            <div className="flex gap-2">
                                                {currentUser?.role === 'admin' && (
                                                    <>
                                                        <button onClick={() => setShowSavedQuotesModal(true)} className="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl font-bold text-sm hover:bg-blue-100 transition-colors flex items-center gap-2 shadow-sm"><Icon name="Archive" size={16}/> Mes Devis</button>
                                                        <button onClick={handleSaveQuote} className="bg-green-600 text-white px-4 py-2 rounded-xl font-bold text-sm hover:bg-green-700 transition-colors flex items-center gap-2 shadow-lg"><Icon name="Save" size={16}/> Sauvegarder</button>
                                                    </>
                                                )}
                                                <button onClick={generateQuotePDF} className="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-sm hover:bg-slate-900 transition-colors flex items-center gap-2 shadow-lg"><Icon name="FileDown" size={16}/> Générer PDF</button>
                                            </div>
                                        </div>
                                        
                                        <div className="grid gap-4 mb-6">
                                            <div className="grid gap-1">
                                                <label className="text-xs font-bold uppercase text-slate-400">Nom du Client / Société</label>
                                                <input className="w-full p-4 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none font-medium text-lg" placeholder="Ex: Ets Agricole du Sud..." value={quote.client} onChange={e => setQuote({...quote, client: e.target.value})} />
                                            </div>
                                        </div>

                                        <div className="bg-slate-50 rounded-2xl border border-slate-100 overflow-hidden">
                                            <div className="p-4 bg-slate-100 border-b border-slate-200 flex justify-between items-center">
                                                <h4 className="font-bold text-sm text-slate-600">Articles ({(quote?.items || []).length})</h4>
                                                <button onClick={openQuoteProductModal} className="text-xs font-bold text-blue-600 bg-white border border-blue-100 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-1"><Icon name="Plus" size={14}/> Ajouter Produit</button>
                                            </div>
                                            
                                            {(quote?.items || []).length === 0 ? (
                                                <div className="p-8 text-center text-slate-400 text-sm">Aucun article ajouté. Commencez par ajouter des produits.</div>
                                            ) : (
                                                <div className="divide-y divide-slate-200">
                                                    {(quote?.items || []).map((item, i) => (
                                                        item && (
                                                            <div key={item.id} className="p-4 flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white">
                                                                <div className="flex-1">
                                                                    <div className="font-bold text-slate-800 flex items-center gap-2">
                                                                        {item.name}
                                                                        {!item.isTaxable ? (<span className="bg-green-100 text-green-700 text-[10px] px-1.5 py-0.5 rounded font-bold uppercase">EXO</span>) : (<span className="bg-slate-100 text-slate-500 text-[10px] px-1.5 py-0.5 rounded font-bold uppercase">TVA 20%</span>)}
                                                                    </div>
                                                                    <div className="text-xs text-slate-500">{item.packaging}</div>
                                                                </div>
                                                                <div className="flex items-center gap-6">
                                                                    <div className="text-center"><div className="text-[10px] text-slate-400 uppercase font-bold">Qté</div><div className="font-bold text-slate-700">{item.qty}</div></div>
                                                                    <div className="text-center"><div className="text-[10px] text-slate-400 uppercase font-bold">P.U.</div><div className="font-bold text-slate-700">{item.basePrice.toFixed(2)}</div></div>
                                                                    <div className="text-right w-24"><div className="text-[10px] text-slate-400 uppercase font-bold">Total HT</div><div className="font-black text-blue-600">{calculateLineTotal(item).toFixed(2)}</div></div>
                                                                    <button onClick={() => removeQuoteItem(item.id)} className="text-red-300 hover:text-red-600 transition-colors"><Icon name="Trash2" size={18}/></button>
                                                                </div>
                                                            </div>
                                                        )
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {(quote?.items || []).length > 0 && (
                                                <div className="bg-slate-100 p-4 border-t border-slate-200">
                                                    <div className="flex justify-end gap-8 text-sm">
                                                        <div className="text-right">
                                                            <div className="text-slate-500">Total HT</div>
                                                            <div className="font-bold text-slate-800 text-lg">
                                                                {(quote?.items || []).reduce((acc, item) => {
                                                                    if (!item) return acc; // GUARD
                                                                    return acc + calculateLineTotal(item);
                                                                }, 0).toFixed(2)} DH
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-slate-500">TTC</div>
                                                            <div className="font-black text-blue-600 text-xl">
                                                                {(() => {
                                                                    let totalHT = 0;
                                                                    let totalTVA = 0;
                                                                    (quote?.items || []).forEach(item => {
                                                                        if (!item) return; // GUARD
                                                                        const line = calculateLineTotal(item);
                                                                        totalHT += line;
                                                                        if(item.isTaxable) totalTVA += line * 0.20;
                                                                    });
                                                                    return (totalHT + totalTVA).toFixed(2);
                                                                })()} DH
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ONSSA TAB (NEW) */}
                            {activeTab === 'onssa' && currentUser.role === 'admin' && (
                                <div className="max-w-4xl mx-auto space-y-8 animate-fade">
                                    <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                                        <div className="flex justify-between items-center mb-6">
                                            <div>
                                                <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="ShieldCheck" className="text-green-600"/> Agréments ONSSA (Excel)</h2>
                                                <p className="text-sm text-slate-500 mt-1">Comparateur de listes officielles pour la veille réglementaire.</p>
                                                <p className="text-xs text-slate-400 mt-1 italic">Format attendu: Région (A), Province (B), Ville (C), Nom (D), Adresse (E)</p>
                                            </div>
                                            {onssaData.report && <button onClick={generateOnssaReportPDF} className="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg flex items-center gap-2 hover:bg-slate-900"><Icon name="FileDown" size={16}/> Rapport PDF</button>}
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                            {/* ZONE 1: BASE */}
                                            <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200 flex flex-col items-center text-center">
                                                <div className="bg-white p-3 rounded-full shadow-sm text-slate-400 mb-3"><Icon name="Database" size={24}/></div>
                                                <h3 className="font-bold text-slate-700 mb-1">Liste de Base (Excel)</h3>
                                                <p className="text-xs text-slate-400 mb-4">{onssaData.baseList.length > 0 ? `${onssaData.baseList.length} revendeurs (Date: ${onssaData.baseDate})` : "Aucune liste définie"}</p>
                                                <button onClick={() => onssaBaseInputRef.current.click()} disabled={isOnssaAnalyzing} className="w-full bg-white border border-slate-300 text-slate-600 py-2 rounded-xl font-bold text-sm hover:bg-slate-100 flex items-center justify-center gap-2"><Icon name="Upload"/> Charger Base (XLSX)</button>
                                                <input type="file" ref={onssaBaseInputRef} accept=".xlsx, .xls" className="hidden" onChange={(e) => handleOnssaExcel(e, 'base')}/>
                                            </div>

                                            {/* ZONE 2: NOUVELLE LISTE */}
                                            <div className="bg-blue-50 p-6 rounded-2xl border border-blue-100 flex flex-col items-center text-center">
                                                <div className="bg-white p-3 rounded-full shadow-sm text-blue-500 mb-3"><Icon name="RefreshCw" size={24} className={isOnssaAnalyzing ? "animate-spin" : ""}/></div>
                                                <h3 className="font-bold text-blue-800 mb-1">Nouvelle Liste (Excel)</h3>
                                                <p className="text-xs text-blue-400 mb-4">{onssaData.newList.length > 0 ? `${onssaData.newList.length} revendeurs (Date: ${onssaData.newDate})` : "En attente de fichier..."}</p>
                                                <button onClick={() => onssaNewInputRef.current.click()} disabled={isOnssaAnalyzing || onssaData.baseList.length === 0} className="w-full bg-blue-600 text-white py-2 rounded-xl font-bold text-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg shadow-blue-200"><Icon name="GitCompare"/> Comparer (XLSX)</button>
                                                <input type="file" ref={onssaNewInputRef} accept=".xlsx, .xls" className="hidden" onChange={(e) => handleOnssaExcel(e, 'new')}/>
                                            </div>
                                        </div>

                                        {isOnssaAnalyzing && (
                                            <div className="bg-slate-900 text-white p-4 rounded-xl mb-6 animate-pulse flex items-center justify-center gap-3">
                                                <Icon name="Loader2" className="animate-spin"/>
                                                <span className="font-mono text-sm">{onssaProgress}</span>
                                            </div>
                                        )}

                                        {/* RESULTATS COMPARAISON */}
                                        {onssaData.report && !isOnssaAnalyzing && (
                                            <div className="animate-fade">
                                                <div className="flex gap-4 mb-6">
                                                    <div className="flex-1 bg-green-50 p-4 rounded-xl border border-green-100 flex items-center gap-4">
                                                        <div className="bg-white p-2 rounded-full text-green-600 shadow-sm"><Icon name="UserPlus" size={24}/></div>
                                                        <div>
                                                            <div className="text-2xl font-black text-green-700">{onssaData.report.countAdded}</div>
                                                            <div className="text-xs font-bold text-green-800 uppercase">Ajoutés</div>
                                                        </div>
                                                    </div>
                                                    <div className="flex-1 bg-red-50 p-4 rounded-xl border border-red-100 flex items-center gap-4">
                                                        <div className="bg-white p-2 rounded-full text-red-500 shadow-sm"><Icon name="UserMinus" size={24}/></div>
                                                        <div>
                                                            <div className="text-2xl font-black text-red-600">{onssaData.report.countRemoved}</div>
                                                            <div className="text-xs font-bold text-red-800 uppercase">Retirés</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* FILTRE RÉGIONS */}
                                                <div className="bg-slate-100 p-4 rounded-2xl mb-6 border border-slate-200">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2"><Icon name="Filter" size={16}/> Filtrer Rapport par Région</h4>
                                                        <button onClick={toggleAllRegions} className="text-xs text-blue-600 font-bold hover:underline">
                                                            {selectedRegions.length === availableRegions.length ? "Tout décocher" : "Tout cocher"}
                                                        </button>
                                                    </div>
                                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1">
                                                        {availableRegions.map(reg => (
                                                            <label key={reg} className="flex items-center gap-2 text-xs bg-white p-2 rounded border border-slate-200 cursor-pointer hover:border-blue-300">
                                                                <input type="checkbox" checked={selectedRegions.includes(reg)} onChange={() => toggleRegion(reg)} className="rounded text-blue-600 focus:ring-blue-500"/>
                                                                <span className="truncate" title={reg}>{reg}</span>
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div className="space-y-6">
                                                    {/* We show raw numbers here, PDF will be filtered */}
                                                    <div className="text-center text-xs text-slate-400 italic mb-4">
                                                        Les tableaux ci-dessous montrent un aperçu global. Utilisez le bouton "Rapport PDF" pour voir le détail filtré par région.
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* ADMIN TAB */}
                            {activeTab === 'admin' && currentUser.role === 'admin' && (
                                <div className="animate-fade grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-1 space-y-6">
                                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800"><Icon name="Settings" /> Paramètres</h3>
                                            <div className="space-y-4">
                                                <div className="grid gap-1"><label className="text-[10px] font-bold uppercase text-slate-400">Token Dropbox</label><input type="password" value={dbxConfig.token} onChange={e => setDbxConfig({...dbxConfig, token: e.target.value})} className="p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono" /></div>
                                                <div className="grid gap-1"><label className="text-[10px] font-bold uppercase text-slate-400">Clé Gemini</label><input type="password" value={dbxConfig.geminiKey} onChange={e => setDbxConfig({...dbxConfig, geminiKey: e.target.value})} className="p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono" /></div>
                                                <div className="bg-blue-50 p-3 rounded-xl border border-blue-100"><label className="text-[10px] font-bold uppercase text-blue-700 block mb-2">Connexion Permanente (OAuth)</label><div className="flex gap-2"><input value={authCode} onChange={e => setAuthCode(e.target.value)} className="flex-1 p-2 border rounded-lg text-xs" placeholder="Coller le Code"/><button onClick={handleExchangeCode} disabled={syncStatus === 'working'} className="bg-green-600 text-white px-3 rounded-lg hover:bg-green-700 font-bold text-xs">Valider</button></div></div>
                                                <div className="pt-4 mt-4 border-t border-slate-100 flex flex-col gap-2"><button onClick={handleManualCloudSave} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl text-xs flex items-center justify-center gap-2 transition-colors shadow-sm"><Icon name="CloudUpload" size={14}/> Publier la Base sur le Cloud (MàJ)</button><button onClick={handleLocalExport} className="w-full bg-slate-100 hover:bg-slate-200 text-slate-500 font-bold py-2 rounded-xl text-xs flex items-center justify-center gap-2 transition-colors"><Icon name="HardDriveDownload" size={14}/> Télécharger Backup Local (Secours)</button></div>
                                            </div>
                                        </div>
                                        <div className="bg-slate-900 text-green-400 p-5 rounded-3xl font-mono text-xs h-60 overflow-y-auto shadow-inner"><div className="opacity-50 border-b border-green-800 pb-2 mb-2">System Logs</div><div className="whitespace-pre-wrap">{syncLog || "Prêt."}</div></div>
                                    </div>
                                    {showAdminUploadModal && (<div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-[60] p-4"><div className="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full animate-fade relative"><button onClick={() => setShowAdminUploadModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="X"/></button><div className="mb-6"><div className="inline-flex bg-blue-100 p-3 rounded-full text-blue-600 mb-3"><Icon name="FilePlus" size={24}/></div><h2 className="text-xl font-bold">Gestion Tarifs</h2><p className="text-sm text-slate-500">Ajouter ou remplacer un catalogue</p></div><form onSubmit={handleManualTarifUpload} className="space-y-4"><div className="flex bg-slate-50 p-1 rounded-xl"><button type="button" onClick={() => setAdminUploadMode('new')} className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${adminUploadMode === 'new' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>Nouveau</button><button type="button" onClick={() => setAdminUploadMode('update')} className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${adminUploadMode === 'update' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>Mise à jour</button></div>{adminUploadMode === 'update' && (<div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Tarif à remplacer</label><select className="w-full p-3 border rounded-xl text-sm bg-white" required value={targetTarifId} onChange={e => setTargetTarifId(e.target.value)}><option value="">-- Choisir --</option>{(tarifs || []).map(t => t && <option key={t.id} value={t.id}>{t.name}</option>)}</select></div>)}<div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Fichier PDF</label><input type="file" accept="application/pdf" required ref={adminFileInputRef} className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Remise T4 (%)</label><input type="number" min="0" max="100" step="0.1" value={t4Value} onChange={e => setT4Value(e.target.value)} className="w-full p-3 border rounded-xl text-sm bg-slate-50 font-mono text-orange-600 font-bold" placeholder="0.0"/><p className="text-[10px] text-slate-400 mt-1">Sera déduit du prix TTC ou EXO pour l'affichage.</p></div><button disabled={syncStatus === 'working'} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold mt-2 hover:bg-slate-900 disabled:opacity-50 flex items-center justify-center gap-2">{syncStatus === 'working' ? <Icon name="Loader2" className="animate-spin"/> : <Icon name="UploadCloud"/>} Valider</button></form></div></div>)}
                                    <div className="lg:col-span-2 bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]"><div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 className="font-bold text-lg text-slate-800">Indexation</h3><div className="flex gap-2"><button onClick={handleDeleteAllTarifs} className="bg-red-50 hover:bg-red-100 text-red-600 px-3 py-2 rounded-xl font-bold text-xs flex items-center gap-1 transition-colors"><Icon name="Trash2" size={14}/> Tout Supprimer</button><button onClick={() => { setAdminUploadMode('new'); setShowAdminUploadModal(true); }} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg shadow-indigo-200 transition-all active:scale-95"><Icon name="Plus"/> Gestion Tarifs</button><button onClick={() => handleSyncFiches()} disabled={syncStatus === 'working'} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg shadow-blue-200 transition-all active:scale-95 disabled:opacity-50"><Icon name={syncStatus === 'working' ? "Loader2" : "RefreshCw"} className={syncStatus === 'working' ? "animate-spin" : ""}/> Scan/Sync Fiches</button></div></div><div className="flex-1 overflow-auto p-0"><table className="w-full text-sm text-left"><thead className="bg-white sticky top-0 shadow-sm text-slate-500 font-bold text-[10px] uppercase"><tr><th className="p-4">Fichier</th><th className="p-4">Type</th><th className="p-4 text-center">Info</th><th className="p-4 text-right">Actions</th></tr></thead><tbody className="divide-y divide-slate-50">{(tarifs || []).map(t => t && (<tr key={t.id} className="hover:bg-blue-50/30 group"><td className="p-4 font-bold text-slate-700">{t.name}</td><td className="p-4"><span className="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">TARIF</span></td><td className="p-4 text-center"><div className="text-blue-600 font-bold">{(t.products || []).length} produits</div>{t.t4_percentage > 0 && <div className="text-xs text-orange-500 font-bold">T4: -{t.t4_percentage}%</div>}</td><td className="p-4 text-right"><div className="flex justify-end gap-2">{t.report && <button onClick={() => setViewingReport(t.report)} className="p-2 text-orange-500 hover:text-orange-700 bg-orange-50 rounded-lg" title="Voir Rapport Fluctuation"><Icon name="TrendingUp" size={16}/></button>}<button onClick={() => handleDeleteEntry('tarif', t.id, t.name)} className="text-slate-300 hover:text-red-500 transition-colors p-2" title="Supprimer"><Icon name="Trash2" size={16}/></button></div></td></tr>))}{(fiches || []).map(f => f && (<tr key={f.id} className="hover:bg-indigo-50/30 group"><td className="p-4 font-bold text-slate-700">{f.name}</td><td className="p-4"><span className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold">FICHE</span></td><td className="p-4 text-center text-slate-400">PDF</td><td className="p-4 text-right"><button onClick={() => handleDeleteEntry('fiche', f.id, f.name)} className="text-slate-300 hover:text-red-500 transition-colors p-2" title="Supprimer"><Icon name="Trash2" size={16}/></button></td></tr>))}</tbody></table></div></div></div>
                            )}

                            {/* SECURITY TAB */}
                            {activeTab === 'security' && currentUser.role === 'admin' && (
                                <div className="max-w-4xl mx-auto space-y-8 animate-fade">
                                    {/* ... Security Content ... */}
                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                        <h3 className="font-bold text-lg mb-6 flex items-center gap-2"><Icon name="Shield" /> Demandes d'autorisation ({(pendingRequests || []).length})</h3>
                                        {(!pendingRequests || pendingRequests.length === 0) ? (
                                            <div className="text-center py-8 text-slate-400 italic text-sm">Aucune demande en attente.</div>
                                        ) : (
                                            <div className="space-y-4">
                                                {(pendingRequests || []).map((req, i) => (
                                                    <div key={i} className="flex flex-col md:flex-row items-center justify-between bg-orange-50 p-4 rounded-2xl border border-orange-100 gap-4">
                                                        <div className="flex items-center gap-4">
                                                            <div className="w-10 h-10 bg-orange-200 text-orange-700 rounded-full flex items-center justify-center font-bold"><Icon name="User"/></div>
                                                            <div>
                                                                <div className="font-bold text-slate-800">{req.user} <span className="text-xs font-normal text-slate-500">({req.login})</span></div>
                                                                <div className="text-xs font-mono text-slate-500 bg-white px-2 py-1 rounded border border-orange-200 mt-1 max-w-[250px] truncate" title={req.deviceId}>{req.deviceId}</div>
                                                                <div className="text-[10px] text-slate-400 mt-1">{req.date}</div>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2 w-full md:w-auto">
                                                            <button onClick={() => handleRejectDevice(req)} className="flex-1 md:flex-none px-4 py-2 bg-white border border-slate-200 text-slate-600 hover:text-red-600 hover:bg-red-50 rounded-xl font-bold text-xs transition-colors">Rejeter</button>
                                                            <button onClick={() => handleApproveDevice(req)} className="flex-1 md:flex-none px-4 py-2 bg-green-600 text-white hover:bg-green-700 rounded-xl font-bold text-xs shadow-lg shadow-green-200 transition-colors">Autoriser</button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {/* AJOUT MANUEL APPAREIL */}
                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                        <h3 className="font-bold text-lg mb-6 flex items-center gap-2"><Icon name="PlusCircle" /> Ajouter un appareil manuellement</h3>
                                        <div className="flex flex-col md:flex-row gap-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                                            <div className="flex-1">
                                                <label className="text-xs font-bold uppercase text-slate-400 block mb-1">ID Appareil (Reçu du collaborateur)</label>
                                                <input value={manualAddId} onChange={e => setManualAddId(e.target.value)} className="w-full p-3 border rounded-xl text-sm font-mono" placeholder="dev_..." />
                                            </div>
                                            <div className="flex-1">
                                                <label className="text-xs font-bold uppercase text-slate-400 block mb-1">Nom Utilisateur</label>
                                                <input value={manualAddName} onChange={e => setManualAddName(e.target.value)} className="w-full p-3 border rounded-xl text-sm" placeholder="Ex: Jean Dupont" />
                                            </div>
                                            <div className="flex items-end">
                                                <button onClick={handleManualAddDevice} className="bg-green-600 text-white px-6 py-3 rounded-xl font-bold text-sm hover:bg-green-700 w-full md:w-auto">Valider</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 opacity-80">
                                        <h3 className="font-bold text-lg mb-6 flex items-center gap-2 text-slate-500"><Icon name="Smartphone" /> Appareils Autorisés ({(authorizedDevices || []).length})</h3>
                                        <div className="max-h-60 overflow-y-auto space-y-2">
                                            {(authorizedDevices || []).map((dev, i) => {
                                                const devId = typeof dev === 'string' ? dev : dev.id;
                                                const devUser = typeof dev === 'object' ? dev.user : 'Ancien Appareil';
                                                const devLogin = typeof dev === 'object' ? dev.login : '';
                                                return (
                                                    <div key={i} className="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                                        <div className="flex flex-col">
                                                            {devUser !== 'Ancien Appareil' && <div className="font-bold text-slate-800 text-sm mb-1">{devUser} <span className="text-slate-400 font-normal text-xs">({devLogin})</span></div>}
                                                            <div className="font-mono text-xs text-slate-600 truncate max-w-[200px] md:max-w-xs">{devId}</div>
                                                        </div>
                                                        <button onClick={() => handleRevokeDevice(dev)} className="text-xs font-bold text-red-400 hover:text-red-600 flex items-center gap-1"><Icon name="XCircle" size={14}/> Révoquer</button>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* USERS TAB */}
                            {activeTab === 'users' && currentUser.role === 'admin' && (
                                <div className="max-w-xl mx-auto space-y-8 animate-fade">
                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                        <h3 className="font-bold text-lg mb-6 flex items-center gap-2"><Icon name={editingUserIdx !== null ? "Edit" : "UserPlus"}/> {editingUserIdx !== null ? "Modifier" : "Créer un accès"}</h3>
                                        <form onSubmit={handleUserSubmit} className="grid gap-4">
                                            <div className="grid grid-cols-2 gap-4"><input value={userFormData.name} onChange={e => setUserFormData({...userFormData, name: e.target.value})} name="name" placeholder="Nom Complet" required className="p-3 border rounded-xl text-sm" /><select value={userFormData.role} onChange={e => setUserFormData({...userFormData, role: e.target.value})} name="role" className="p-3 border rounded-xl text-sm bg-white"><option value="viewer">Collaborateur</option><option value="admin">Administrateur</option></select></div>
                                            <div className="grid grid-cols-2 gap-4"><input value={userFormData.login} onChange={e => setUserFormData({...userFormData, login: e.target.value})} name="login" placeholder="Identifiant" required className="p-3 border rounded-xl text-sm" /><input value={userFormData.pass} onChange={e => setUserFormData({...userFormData, pass: e.target.value})} name="pass" placeholder="Mot de passe" required className="p-3 border rounded-xl text-sm" /></div>
                                            <div className="flex gap-2 mt-2"><button className="flex-1 bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition-colors">{editingUserIdx !== null ? "Enregistrer" : "Ajouter"}</button>{editingUserIdx !== null && (<button type="button" onClick={() => { setEditingUserIdx(null); setUserFormData({ name: '', login: '', pass: '', role: 'viewer' }); }} className="bg-slate-100 text-slate-500 py-3 px-4 rounded-xl font-bold hover:bg-slate-200">Annuler</button>)}</div>
                                        </form>
                                    </div>
                                    <div className="space-y-3">
                                        <h4 className="text-xs font-bold uppercase text-slate-400 pl-4">Utilisateurs</h4>
                                        {(users || []).map((u, i) => (
                                            <div key={i} className="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl group">
                                                <div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${u.role === 'admin' ? 'bg-slate-800' : 'bg-blue-500'}`}>{u.name.charAt(0)}</div><div><div className="font-bold text-slate-800">{u.name}</div><div className="text-xs text-slate-500 font-mono flex items-center gap-2"><span>{u.id}</span><span className="text-slate-300">|</span><button onClick={() => setShowPassword({...showPassword, [i]: !showPassword[i]})} className="flex items-center gap-1 hover:text-blue-600 transition-colors">{showPassword[i] ? u.pass : "••••••"}<Icon name={showPassword[i] ? "EyeOff" : "Eye"} size={10}/></button></div></div></div>
                                                <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    {u.id !== 'SUPERADMIN' && (
                                                        <>
                                                            <button onClick={() => { setUserFormData({ name: u.name, login: u.id, pass: u.pass, role: u.role }); setEditingUserIdx(i); }} className="p-2 text-blue-400 hover:text-blue-600 bg-blue-50 rounded-lg"><Icon name="Edit2" size={16}/></button>
                                                            <button onClick={() => { if(confirm('Supprimer ?')) setUsers(users.filter((_, idx) => idx !== i)); }} className="p-2 text-red-400 hover:text-red-600 bg-red-50 rounded-lg"><Icon name="Trash2" size={16}/></button>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </ErrorBoundary>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>